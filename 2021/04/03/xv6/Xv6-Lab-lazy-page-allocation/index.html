<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Lab: xv6 lazy page allocation https:&#x2F;&#x2F;pdos.csail.mit.edu&#x2F;6.S081&#x2F;2020&#x2F;labs&#x2F;lazy.html 新的 2020 版哦。  123$ git fetch$ git checkout lazy$ make clean Eliminate allocation from sbrk()就是把 sys_sbrk 里的 growproc">
<meta property="og:type" content="article">
<meta property="og:title" content="Xv6 Lab lazy page allocation">
<meta property="og:url" content="https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/index.html">
<meta property="og:site_name" content="clownote">
<meta property="og:description" content="Lab: xv6 lazy page allocation https:&#x2F;&#x2F;pdos.csail.mit.edu&#x2F;6.S081&#x2F;2020&#x2F;labs&#x2F;lazy.html 新的 2020 版哦。  123$ git fetch$ git checkout lazy$ make clean Eliminate allocation from sbrk()就是把 sys_sbrk 里的 growproc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://api.ixiaowai.cn/api/api.php">
<meta property="article:published_time" content="2021-04-03T13:15:52.722Z">
<meta property="article:modified_time" content="2021-07-14T16:17:22.729Z">
<meta property="article:author" content="CDFMLR">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://api.ixiaowai.cn/api/api.php">
    
    
        
          
              <link rel="shortcut icon" href="/images/rabbit.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/rabbit_192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/rabbit_180.png">
          
        
    
    <!-- title -->
    <title>Xv6 Lab lazy page allocation</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
    <!--Google search varification (PRIVATE)-->
    <meta name="google-site-verification" content="MrqlpFAD8nDanw3Ypv7ZsIWHLnTdhRuLa4QhSVwxIvc" />
    <!--Google AdSense 关联 (PRIVATE)-->
    <script data-ad-client="ca-pub-1510963483941114" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/04/06/xv6/Xv6-Locking/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/03/29/xv6/Xv6-Interrupts-and-device-drivers/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&text=Xv6 Lab lazy page allocation"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&is_video=false&description=Xv6 Lab lazy page allocation"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Xv6 Lab lazy page allocation&body=Check out this article: https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&name=Xv6 Lab lazy page allocation&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-xv6-lazy-page-allocation"><span class="toc-number">1.</span> <span class="toc-text">Lab: xv6 lazy page allocation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eliminate-allocation-from-sbrk"><span class="toc-number">1.1.</span> <span class="toc-text">Eliminate allocation from sbrk()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lazy-allocation"><span class="toc-number">1.2.</span> <span class="toc-text">Lazy allocation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#diff"><span class="toc-number">1.4.</span> <span class="toc-text">diff</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">1.5.</span> <span class="toc-text">结果</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Xv6 Lab lazy page allocation
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">clownote</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-04-03T13:15:52.722Z" itemprop="datePublished">2021-04-03</time>
        
        (Updated: <time datetime="2021-07-14T16:17:22.729Z" itemprop="dateModified">2021-07-14</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/xv6/" rel="tag">xv6</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://api.ixiaowai.cn/api/api.php" alt="Meaning Unknown&#39;s Head Image"></p>
<h1 id="Lab-xv6-lazy-page-allocation"><a href="#Lab-xv6-lazy-page-allocation" class="headerlink" title="Lab: xv6 lazy page allocation"></a>Lab: xv6 lazy page allocation</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2020/labs/lazy.html">https://pdos.csail.mit.edu/6.S081/2020/labs/lazy.html</a></p>
<p>新的 2020 版哦。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git fetch</span><br><span class="line">$ git checkout lazy</span><br><span class="line">$ make clean</span><br></pre></td></tr></table></figure>
<h2 id="Eliminate-allocation-from-sbrk"><a href="#Eliminate-allocation-from-sbrk" class="headerlink" title="Eliminate allocation from sbrk()"></a>Eliminate allocation from sbrk()</h2><p>就是把 sys_sbrk 里的 growproc 调用删了，等用到的时候再去分配内存。如果是空间减小，要取消分配。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line">sys_sbrk(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> addr;</span><br><span class="line">  <span class="keyword">int</span> n;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();  <span class="comment">//(+)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  addr = p-&gt;sz;  <span class="comment">// old sz</span></span><br><span class="line">  p-&gt;sz += n;</span><br><span class="line">  <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;  <span class="comment">// 空间减小: 取消分配</span></span><br><span class="line">    uvmdealloc(p-&gt;pagetable, addr, p-&gt;sz);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Lazy-allocation"><a href="#Lazy-allocation" class="headerlink" title="Lazy allocation"></a>Lazy allocation</h2><p>在 <code>vm.c</code> 里面实现惰性分配（莫忘在 defs.h 中声明函数）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spinlock.h&quot;</span> <span class="comment">//(+)</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;proc.h&quot;</span>     <span class="comment">//(+)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// lazy allocation memory va for proc p: handle page-fault.</span></span><br><span class="line"><span class="comment">// return allocated memory (pa), 0 for failed </span></span><br><span class="line"><span class="function">uint64 <span class="title">lazyalloc</span><span class="params">(struct proc * p, uint64 va)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(va &gt;= p-&gt;sz || va &lt; PGROUNDUP(p-&gt;trapframe-&gt;sp))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">char</span> * mem;</span><br><span class="line">  uint64 a = PGROUNDDOWN(va);</span><br><span class="line">  mem = kalloc();</span><br><span class="line">  <span class="keyword">if</span>(mem == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(mem, <span class="number">0</span>, PGSIZE);  </span><br><span class="line">    <span class="keyword">if</span>(mappages(p-&gt;pagetable, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != <span class="number">0</span>)&#123;</span><br><span class="line">      kfree(mem);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (uint64)mem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 usertrap (<code>trap.c</code>) 里处理缺页错误，尝试惰性分配（掉上面写的那个函数，失败就杀掉进程）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">usertrap(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span>(r_scause() == <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="comment">// system call</span></span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((which_dev = devintr()) != <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">// ok</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>((r_scause() == <span class="number">13</span>) || (r_scause() == <span class="number">15</span>))&#123;  <span class="comment">// page fault: (+)</span></span><br><span class="line">  <span class="keyword">if</span> (lazyalloc(myproc(), r_stval()) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后改一点点细节，把各种缺页会爆出的 panic 干掉（vm.c里）。以前这些情况正常是不会发生的，但现在惰性分配会带来缺页，所以要告诉操作系统遇到这些事情时 don’t panic，继续往下跑就行了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm.c</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//(+)这个我懒得改结构就goto了，但你应该去改if结构，而不是goto</span></span><br><span class="line">uint64</span><br><span class="line">walkaddr(<span class="keyword">pagetable_t</span> pagetable, uint64 va)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(pte == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> lzac;</span><br><span class="line">  <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> lzac;</span><br><span class="line">  <span class="keyword">if</span>((*pte &amp; PTE_U) == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> lzac;</span><br><span class="line">  pa = PTE2PA(*pte);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span>) &#123;</span><br><span class="line">lzac:</span><br><span class="line">    <span class="keyword">if</span> ((pa = lazyalloc(myproc(), va)) &lt;= <span class="number">0</span>)</span><br><span class="line">      pa = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> pa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">mappages(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span class="keyword">int</span> perm)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_V)</span><br><span class="line">      <span class="comment">// panic(&quot;remap&quot;);</span></span><br><span class="line">      ;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">uvmunmap(<span class="keyword">pagetable_t</span> pagetable, uint64 va, uint64 npages, <span class="keyword">int</span> do_free)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span>(a = va; a &lt; va + npages*PGSIZE; a += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(pagetable, a, <span class="number">0</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// panic(&quot;uvmunmap: walk&quot;);</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// panic(&quot;uvmunmap: not mapped&quot;);</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">uvmcopy(<span class="keyword">pagetable_t</span> old, <span class="keyword">pagetable_t</span> <span class="keyword">new</span>, uint64 sz)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">    <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// panic(&quot;uvmcopy: pte should exist&quot;);</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">// panic(&quot;uvmcopy: page not present&quot;);</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>写的时候可以按题目跑这些测试：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xv6-labs-2020 $ make qemu</span><br><span class="line">$ <span class="built_in">echo</span> hi</span><br><span class="line">$ lazytests</span><br><span class="line">$ usertests</span><br></pre></td></tr></table></figure>
<h2 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h2><p>详细的 git diff (可以用来做 patch 喔):</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 4b9bbc0..7ff16c4 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -171,6 +171,7 @@</span> uint64          walkaddr(pagetable_t, uint64);</span><br><span class="line"> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"><span class="addition">+uint64          lazyalloc(struct proc * p, uint64 va);</span></span><br><span class="line"> </span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index e8bcda9..b799722 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -43,12 +43,15 @@</span> sys_sbrk(void)</span><br><span class="line"> &#123;</span><br><span class="line">   int addr;</span><br><span class="line">   int n;</span><br><span class="line"><span class="addition">+  struct proc *p = myproc();</span></span><br><span class="line"> </span><br><span class="line">   if(argint(0, &amp;n) &lt; 0)</span><br><span class="line">     return -1;</span><br><span class="line"><span class="deletion">-  addr = myproc()-&gt;sz;</span></span><br><span class="line"><span class="deletion">-  if(growproc(n) &lt; 0)</span></span><br><span class="line"><span class="deletion">-    return -1;</span></span><br><span class="line"><span class="addition">+  addr = p-&gt;sz;  // old sz</span></span><br><span class="line"><span class="addition">+  p-&gt;sz += n;</span></span><br><span class="line"><span class="addition">+  if (n &lt; 0) &#123;</span></span><br><span class="line"><span class="addition">+    uvmdealloc(p-&gt;pagetable, addr, p-&gt;sz);</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line">   return addr;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/kernel/trap.c b/kernel/trap.c</span></span><br><span class="line"><span class="comment">index a63249e..fc08231 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/trap.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/trap.c</span></span><br><span class="line"><span class="meta">@@ -67,6 +67,11 @@</span> usertrap(void)</span><br><span class="line">     syscall();</span><br><span class="line">   &#125; else if((which_dev = devintr()) != 0)&#123;</span><br><span class="line">     // ok</span><br><span class="line"><span class="addition">+  &#125; else if((r_scause() == 13) || (r_scause() == 15))&#123;  // page fault</span></span><br><span class="line"><span class="addition">+	// lazy allocation</span></span><br><span class="line"><span class="addition">+	if (lazyalloc(myproc(), r_stval()) &lt;= 0) &#123;</span></span><br><span class="line"><span class="addition">+	  p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     printf(&quot;usertrap(): unexpected scause %p pid=%d\n&quot;, r_scause(), p-&gt;pid);</span><br><span class="line">     printf(&quot;            sepc=%p stval=%p\n&quot;, r_sepc(), r_stval());</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index bccb405..f3235c3 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -5,6 +5,8 @@</span></span><br><span class="line"> #include &quot;riscv.h&quot;</span><br><span class="line"> #include &quot;defs.h&quot;</span><br><span class="line"> #include &quot;fs.h&quot;</span><br><span class="line"><span class="addition">+#include &quot;spinlock.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;proc.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> /*</span><br><span class="line">  * the kernel&#x27;s page table.</span><br><span class="line"><span class="meta">@@ -102,12 +104,19 @@</span> walkaddr(pagetable_t pagetable, uint64 va)</span><br><span class="line"> </span><br><span class="line">   pte = walk(pagetable, va, 0);</span><br><span class="line">   if(pte == 0)</span><br><span class="line"><span class="deletion">-    return 0;</span></span><br><span class="line"><span class="addition">+	goto lzac;</span></span><br><span class="line">   if((*pte &amp; PTE_V) == 0)</span><br><span class="line"><span class="deletion">-    return 0;</span></span><br><span class="line"><span class="addition">+    goto lzac;</span></span><br><span class="line">   if((*pte &amp; PTE_U) == 0)</span><br><span class="line"><span class="deletion">-    return 0;</span></span><br><span class="line"><span class="addition">+    goto lzac;</span></span><br><span class="line">   pa = PTE2PA(*pte);</span><br><span class="line"><span class="addition">+ </span></span><br><span class="line"><span class="addition">+  if (0) &#123;</span></span><br><span class="line"><span class="addition">+lzac:</span></span><br><span class="line"><span class="addition">+	  if ((pa = lazyalloc(myproc(), va)) &lt;= 0)</span></span><br><span class="line"><span class="addition">+		pa = 0;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+  </span></span><br><span class="line">   return pa;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -157,7 +166,8 @@</span> mappages(pagetable_t pagetable, uint64 va, uint64 size, uint64 pa, int perm)</span><br><span class="line">     if((pte = walk(pagetable, a, 1)) == 0)</span><br><span class="line">       return -1;</span><br><span class="line">     if(*pte &amp; PTE_V)</span><br><span class="line"><span class="deletion">-      panic(&quot;remap&quot;);</span></span><br><span class="line"><span class="addition">+      // panic(&quot;remap&quot;);</span></span><br><span class="line"><span class="addition">+	  ;</span></span><br><span class="line">     *pte = PA2PTE(pa) | perm | PTE_V;</span><br><span class="line">     if(a == last)</span><br><span class="line">       break;</span><br><span class="line"><span class="meta">@@ -180,10 +190,14 @@</span> uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, int do_free)</span><br><span class="line">     panic(&quot;uvmunmap: not aligned&quot;);</span><br><span class="line"> </span><br><span class="line">   for(a = va; a &lt; va + npages*PGSIZE; a += PGSIZE)&#123;</span><br><span class="line"><span class="deletion">-    if((pte = walk(pagetable, a, 0)) == 0)</span></span><br><span class="line"><span class="deletion">-      panic(&quot;uvmunmap: walk&quot;);</span></span><br><span class="line"><span class="deletion">-    if((*pte &amp; PTE_V) == 0)</span></span><br><span class="line"><span class="deletion">-      panic(&quot;uvmunmap: not mapped&quot;);</span></span><br><span class="line"><span class="addition">+    if((pte = walk(pagetable, a, 0)) == 0) &#123;</span></span><br><span class="line"><span class="addition">+      // panic(&quot;uvmunmap: walk&quot;);</span></span><br><span class="line"><span class="addition">+	  continue;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line"><span class="addition">+    if((*pte &amp; PTE_V) == 0) &#123;</span></span><br><span class="line"><span class="addition">+      // panic(&quot;uvmunmap: not mapped&quot;);</span></span><br><span class="line"><span class="addition">+	  continue;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line">     if(PTE_FLAGS(*pte) == PTE_V)</span><br><span class="line">       panic(&quot;uvmunmap: not a leaf&quot;);</span><br><span class="line">     if(do_free)&#123;</span><br><span class="line"><span class="meta">@@ -314,10 +328,14 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">   char *mem;</span><br><span class="line"> </span><br><span class="line">   for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line"><span class="deletion">-    if((pte = walk(old, i, 0)) == 0)</span></span><br><span class="line"><span class="deletion">-      panic(&quot;uvmcopy: pte should exist&quot;);</span></span><br><span class="line"><span class="deletion">-    if((*pte &amp; PTE_V) == 0)</span></span><br><span class="line"><span class="deletion">-      panic(&quot;uvmcopy: page not present&quot;);</span></span><br><span class="line"><span class="addition">+    if((pte = walk(old, i, 0)) == 0)&#123;</span></span><br><span class="line"><span class="addition">+      // panic(&quot;uvmcopy: pte should exist&quot;);</span></span><br><span class="line"><span class="addition">+	  continue;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line"><span class="addition">+    if((*pte &amp; PTE_V) == 0)&#123;</span></span><br><span class="line"><span class="addition">+      // panic(&quot;uvmcopy: page not present&quot;);</span></span><br><span class="line"><span class="addition">+	  continue;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line">     pa = PTE2PA(*pte);</span><br><span class="line">     flags = PTE_FLAGS(*pte);</span><br><span class="line">     if((mem = kalloc()) == 0)</span><br><span class="line"><span class="meta">@@ -440,3 +458,40 @@</span> copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span><br><span class="line">     return -1;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// lazy allocation memory va for proc p: handle page-fault.</span></span><br><span class="line"><span class="addition">+// return allocated memory (pa), 0 for failed </span></span><br><span class="line"><span class="addition">+uint64 lazyalloc(struct proc * p, uint64 va)&#123;</span></span><br><span class="line"><span class="addition">+#define lazyalloc_debug 0</span></span><br><span class="line"><span class="addition">+#define lazyalloc_warn(info) &#123; \</span></span><br><span class="line"><span class="addition">+	  printf(&quot;lazyalloc(): %s&quot;, info); \</span></span><br><span class="line"><span class="addition">+      printf(&quot;             scause %p pid=%d\n&quot;, r_scause(), p-&gt;pid); \</span></span><br><span class="line"><span class="addition">+      printf(&quot;             sepc=%p stval=%p\n&quot;, r_sepc(), r_stval()); \</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+	if(va &gt;= p-&gt;sz || va &lt; PGROUNDUP(p-&gt;trapframe-&gt;sp))&#123;</span></span><br><span class="line"><span class="addition">+	  #if lazyalloc_debug</span></span><br><span class="line"><span class="addition">+	    lazyalloc_warn(&quot;vm addr higher then any allocated with sbrk\n&quot;);</span></span><br><span class="line"><span class="addition">+      #endif</span></span><br><span class="line"><span class="addition">+	  return 0;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line"><span class="addition">+	char * mem;</span></span><br><span class="line"><span class="addition">+	uint64 a = PGROUNDDOWN(va);</span></span><br><span class="line"><span class="addition">+	mem = kalloc();</span></span><br><span class="line"><span class="addition">+	if(mem == 0)&#123;</span></span><br><span class="line"><span class="addition">+	  #if lazyalloc_debug</span></span><br><span class="line"><span class="addition">+	    lazyalloc_warn(&quot;kalloc() == 0\n&quot;);</span></span><br><span class="line"><span class="addition">+      #endif</span></span><br><span class="line"><span class="addition">+	  return 0;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line"><span class="addition">+	memset(mem, 0, PGSIZE);  </span></span><br><span class="line"><span class="addition">+    if(mappages(p-&gt;pagetable, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != 0)&#123;</span></span><br><span class="line"><span class="addition">+	  #if lazyalloc_debug</span></span><br><span class="line"><span class="addition">+ 	    lazyalloc_warn(&quot;mappages() != 0\n&quot;);</span></span><br><span class="line"><span class="addition">+      #endif</span></span><br><span class="line"><span class="addition">+	  kfree(mem);</span></span><br><span class="line"><span class="addition">+	  return 0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	return (uint64)mem;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>最后 make grade 看成绩了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">xv6-labs-2020 $ make grade</span><br><span class="line">...</span><br><span class="line">== Test running lazytests == </span><br><span class="line">$ make qemu-gdb</span><br><span class="line">(7.7s) </span><br><span class="line">== Test   lazy: map == </span><br><span class="line">  lazy: map: OK </span><br><span class="line">== Test   lazy: unmap == </span><br><span class="line">  lazy: unmap: OK </span><br><span class="line">== Test usertests == </span><br><span class="line">$ make qemu-gdb</span><br><span class="line">(145.8s) </span><br><span class="line">== Test   usertests: pgbug == </span><br><span class="line">  usertests: pgbug: OK </span><br><span class="line">== Test   usertests: sbrkbugs == </span><br><span class="line">  usertests: sbrkbugs: OK </span><br><span class="line">== Test   usertests: argptest == </span><br><span class="line">  usertests: argptest: OK </span><br><span class="line">== Test   usertests: sbrkmuch == </span><br><span class="line">  usertests: sbrkmuch: OK </span><br><span class="line">== Test   usertests: sbrkfail == </span><br><span class="line">  usertests: sbrkfail: OK </span><br><span class="line">== Test   usertests: sbrkarg == </span><br><span class="line">  usertests: sbrkarg: OK </span><br><span class="line">== Test   usertests: stacktest == </span><br><span class="line">  usertests: stacktest: OK </span><br><span class="line">== Test   usertests: execout == </span><br><span class="line">  usertests: execout: OK </span><br><span class="line">== Test   usertests: copyin == </span><br><span class="line">  usertests: copyin: OK </span><br><span class="line">== Test   usertests: copyout == </span><br><span class="line">  usertests: copyout: OK </span><br><span class="line">== Test   usertests: copyinstr1 == </span><br><span class="line">  usertests: copyinstr1: OK </span><br><span class="line">== Test   usertests: copyinstr2 == </span><br><span class="line">  usertests: copyinstr2: OK </span><br><span class="line">== Test   usertests: copyinstr3 == </span><br><span class="line">  usertests: copyinstr3: OK </span><br><span class="line">== Test   usertests: rwsbrk == </span><br><span class="line">  usertests: rwsbrk: OK </span><br><span class="line">== Test   usertests: truncate1 == </span><br><span class="line">  usertests: truncate1: OK </span><br><span class="line">== Test   usertests: truncate2 == </span><br><span class="line">  usertests: truncate2: OK </span><br><span class="line">== Test   usertests: truncate3 == </span><br><span class="line">  usertests: truncate3: OK </span><br><span class="line">== Test   usertests: reparent2 == </span><br><span class="line">  usertests: reparent2: OK </span><br><span class="line">== Test   usertests: badarg == </span><br><span class="line">  usertests: badarg: OK </span><br><span class="line">== Test   usertests: reparent == </span><br><span class="line">  usertests: reparent: OK </span><br><span class="line">== Test   usertests: twochildren == </span><br><span class="line">  usertests: twochildren: OK </span><br><span class="line">== Test   usertests: forkfork == </span><br><span class="line">  usertests: forkfork: OK </span><br><span class="line">== Test   usertests: forkforkfork == </span><br><span class="line">  usertests: forkforkfork: OK </span><br><span class="line">== Test   usertests: createdelete == </span><br><span class="line">  usertests: createdelete: OK </span><br><span class="line">== Test   usertests: linkunlink == </span><br><span class="line">  usertests: linkunlink: OK </span><br><span class="line">== Test   usertests: linktest == </span><br><span class="line">  usertests: linktest: OK </span><br><span class="line">== Test   usertests: unlinkread == </span><br><span class="line">  usertests: unlinkread: OK </span><br><span class="line">== Test   usertests: concreate == </span><br><span class="line">  usertests: concreate: OK </span><br><span class="line">== Test   usertests: subdir == </span><br><span class="line">  usertests: subdir: OK </span><br><span class="line">== Test   usertests: fourfiles == </span><br><span class="line">  usertests: fourfiles: OK </span><br><span class="line">== Test   usertests: sharedfd == </span><br><span class="line">  usertests: sharedfd: OK </span><br><span class="line">== Test   usertests: exectest == </span><br><span class="line">  usertests: exectest: OK </span><br><span class="line">== Test   usertests: bigargtest == </span><br><span class="line">  usertests: bigargtest: OK </span><br><span class="line">== Test   usertests: bigwrite == </span><br><span class="line">  usertests: bigwrite: OK </span><br><span class="line">== Test   usertests: bsstest == </span><br><span class="line">  usertests: bsstest: OK </span><br><span class="line">== Test   usertests: sbrkbasic == </span><br><span class="line">  usertests: sbrkbasic: OK </span><br><span class="line">== Test   usertests: kernmem == </span><br><span class="line">  usertests: kernmem: OK </span><br><span class="line">== Test   usertests: validatetest == </span><br><span class="line">  usertests: validatetest: OK </span><br><span class="line">== Test   usertests: opentest == </span><br><span class="line">  usertests: opentest: OK </span><br><span class="line">== Test   usertests: writetest == </span><br><span class="line">  usertests: writetest: OK </span><br><span class="line">== Test   usertests: writebig == </span><br><span class="line">  usertests: writebig: OK </span><br><span class="line">== Test   usertests: createtest == </span><br><span class="line">  usertests: createtest: OK </span><br><span class="line">== Test   usertests: openiput == </span><br><span class="line">  usertests: openiput: OK </span><br><span class="line">== Test   usertests: exitiput == </span><br><span class="line">  usertests: exitiput: OK </span><br><span class="line">== Test   usertests: iput == </span><br><span class="line">  usertests: iput: OK </span><br><span class="line">== Test   usertests: mem == </span><br><span class="line">  usertests: mem: OK </span><br><span class="line">== Test   usertests: pipe1 == </span><br><span class="line">  usertests: pipe1: OK </span><br><span class="line">== Test   usertests: preempt == </span><br><span class="line">  usertests: preempt: OK </span><br><span class="line">== Test   usertests: exitwait == </span><br><span class="line">  usertests: exitwait: OK </span><br><span class="line">== Test   usertests: rmdot == </span><br><span class="line">  usertests: rmdot: OK </span><br><span class="line">== Test   usertests: fourteen == </span><br><span class="line">  usertests: fourteen: OK </span><br><span class="line">== Test   usertests: bigfile == </span><br><span class="line">  usertests: bigfile: OK </span><br><span class="line">== Test   usertests: dirfile == </span><br><span class="line">  usertests: dirfile: OK </span><br><span class="line">== Test   usertests: iref == </span><br><span class="line">  usertests: iref: OK </span><br><span class="line">== Test   usertests: forktest == </span><br><span class="line">  usertests: forktest: OK </span><br><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: 119/119</span><br></pre></td></tr></table></figure>
<hr>
<p>2021.04.03  CDFMLR</p>
<p>顶部图片来自于<a target="_blank" rel="noopener" href="https://api.ixiaowai.cn/">小歪API</a>，系随机选取的图片，仅用于检测屏幕显示的机械、光电性能，与文章的任何内容及观点无关，也并不代表本人局部或全部同意、支持或者反对其中的任何内容及观点。如有侵权，联系删除。</p>

  </div>
</article>
<!--Disqus-->


<!--Livere-->

    <div class="blog-post-comments">
        <div id="lv-container" data-id="city" data-uid="MTAyMC80NjEzMi8yMjY0Mw==">
            <noscript>不启用 JavaScript 支持的人是看不到可爱的评论区的。😥</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-xv6-lazy-page-allocation"><span class="toc-number">1.</span> <span class="toc-text">Lab: xv6 lazy page allocation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eliminate-allocation-from-sbrk"><span class="toc-number">1.1.</span> <span class="toc-text">Eliminate allocation from sbrk()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lazy-allocation"><span class="toc-number">1.2.</span> <span class="toc-text">Lazy allocation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#diff"><span class="toc-number">1.4.</span> <span class="toc-text">diff</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">1.5.</span> <span class="toc-text">结果</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&text=Xv6 Lab lazy page allocation"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&is_video=false&description=Xv6 Lab lazy page allocation"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Xv6 Lab lazy page allocation&body=Check out this article: https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&title=Xv6 Lab lazy page allocation"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://clownote.github.io/2021/04/03/xv6/Xv6-Lab-lazy-page-allocation/&name=Xv6 Lab lazy page allocation&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 CDFMLR
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-146911386-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?9a0d2e6fde93dad496ac79f04f3aba97";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


<!--Livere Comments-->

    <script type="text/javascript">
      (function (d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>

</body>
</html>
