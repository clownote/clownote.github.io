<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Introducing: Sham1024那天写了篇的文章《Python 代码一键转流程图》。CSDN 居然给了个 “最趣味”奖🏆：https:&#x2F;&#x2F;blogdev.blog.csdn.net&#x2F;article&#x2F;details&#x2F;109536460 。 一开始我是不知道获奖的事的，（害，咱想都不敢想），直到有一天， CSDN 的小姐姐主动来加我微信，怒斥我仍未填写收货地址[捂脸]。。。 经历了一些曲折">
<meta property="og:type" content="article">
<meta property="og:title" content="Introducing Sham">
<meta property="og:url" content="https://clownote.github.io/2020/11/16/blog/Intro_sham/index.html">
<meta property="og:site_name" content="clownote">
<meta property="og:description" content="Introducing: Sham1024那天写了篇的文章《Python 代码一键转流程图》。CSDN 居然给了个 “最趣味”奖🏆：https:&#x2F;&#x2F;blogdev.blog.csdn.net&#x2F;article&#x2F;details&#x2F;109536460 。 一开始我是不知道获奖的事的，（害，咱想都不敢想），直到有一天， CSDN 的小姐姐主动来加我微信，怒斥我仍未填写收货地址[捂脸]。。。 经历了一些曲折">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkrcr94smgj30vm0u0kjo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gknstu9g88j31e00u0dkx.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkndrmwyhcj31hm09sn1b.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkndndoqc4j31jc0dk7au.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gknf17o30tj31jj0u0hbm.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkrbyvn0lkj30u0145gx2.jpg">
<meta property="article:published_time" content="2020-11-16T19:22:07.677Z">
<meta property="article:modified_time" content="2022-03-10T10:36:45.740Z">
<meta property="article:author" content="CDFMLR">
<meta property="article:tag" content="CDFMLR, blogs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/0081Kckwly1gkrcr94smgj30vm0u0kjo.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/rabbit.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/rabbit_192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/rabbit_180.png">
          
        
    
    <!-- title -->
    <title>Introducing Sham</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
    <!--Google search varification (PRIVATE)-->
    <meta name="google-site-verification" content="MrqlpFAD8nDanw3Ypv7ZsIWHLnTdhRuLa4QhSVwxIvc" />
    <!--Google AdSense 关联 (PRIVATE)-->
    <script data-ad-client="ca-pub-1510963483941114" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/11/24/blog/python_removesuffix/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/10/24/blog/PyFlowchart/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://clownote.github.io/2020/11/16/blog/Intro_sham/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&text=Introducing Sham"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&is_video=false&description=Introducing Sham"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Introducing Sham&body=Check out this article: https://clownote.github.io/2020/11/16/blog/Intro_sham/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&name=Introducing Sham&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introducing-Sham"><span class="toc-number">1.</span> <span class="toc-text">Introducing: Sham</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B7%E5%9B%A0"><span class="toc-number">1.1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sham-%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">Sham 系统概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">抽象结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">系统的工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%BF%90%E8%A1%8C"><span class="toc-number">1.2.3.</span> <span class="toc-text">线程的运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E4%B8%8E-IO"><span class="toc-number">1.2.4.</span> <span class="toc-text">中断与 IO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sham-%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">Sham 程序设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8C-Sham"><span class="toc-number">1.3.1.</span> <span class="toc-text">如何运行 Sham?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text">顺序程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text">变量使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6-%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.3.5.</span> <span class="toc-text">条件&#x2F;循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1-Pipe"><span class="toc-number">1.3.6.</span> <span class="toc-text">进程通信: Pipe</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E7%BB%93%E6%9D%9F%E4%B9%8B%E5%89%8D"><span class="toc-number">1.4.</span> <span class="toc-text">文章结束之前</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Introducing Sham
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">clownote</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-11-16T19:22:07.677Z" itemprop="datePublished">2020-11-16</time>
        
        (Updated: <time datetime="2022-03-10T10:36:45.740Z" itemprop="dateModified">2022-03-10</time>)
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Introducing-Sham"><a href="#Introducing-Sham" class="headerlink" title="Introducing: Sham"></a>Introducing: Sham</h1><p>1024那天写了篇的文章《<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012419550/article/details/109258117">Python 代码一键转流程图</a>》。CSDN 居然给了个 “最趣味”奖🏆：<a target="_blank" rel="noopener" href="https://blogdev.blog.csdn.net/article/details/109536460">https://blogdev.blog.csdn.net/article/details/109536460</a> 。</p>
<p>一开始我是不知道获奖的事的，（害，咱想都不敢想），直到有一天， CSDN 的小姐姐主动来加我微信，怒斥我仍未填写收货地址[捂脸]。。。</p>
<p>经历了一些曲折，前两天我终于还是收到了 CSDN 的奖品：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkrcr94smgj30vm0u0kjo.jpg" alt="截屏2020-11-16 21.49.18"></p>
<p>感谢 CSDN 🙏。</p>
<p>不过，这不是今天的主题，<del>只是炫耀一下</del>。今天要讲的故事是：</p>
<p><strong>我这个人不懂什么操作系统，于是我用 Go 语言模拟出了一个……</strong></p>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>以前看过一篇文章叫做《<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/eezs6MTL-quuG0q5jBoMyw">我这个人不懂什么CPU，于是我用代码模拟出了一个</a>》。这篇文章介绍了一位大佬一言不合用 Go 语言模拟了一台计算机（项目：<a target="_blank" rel="noopener" href="https://github.com/djhworld/simple-computer">djhworld/simple-computer</a>）的故事，帅爆了好吗。</p>
<p>这学期有操作系统课，上这个课程的主要收获就是，课上那些活在 PPT 中的算法，就很迷！我是不太喜欢这种方式的，我奉行 <em>Talk is cheap. Show me the code.</em></p>
<p>所以，我也用 Go 语言模拟了一个“操作系统”——一个拥有标准输入输出与进程间通信的、基于时间片轮转调度的多道程序运行器：<a target="_blank" rel="noopener" href="https://github.com/cdfmlr/sham">cdfmlr/sham</a> （sham 意为：骗局、虚假事物）。</p>
<p>取名叫做 sham 就是希望大家原谅我的标题党行为，事实上，这个东西远谈不上一个“操作系统”，和 <a target="_blank" rel="noopener" href="https://github.com/djhworld/simple-computer">djhworld/simple-computer</a> 等类似的优秀项目比起来，，我做的什么都不是。但我只做了不到 10 分钟的设计，并用不到 2k 行代码实现了它。作为业余蒟蒻实现的玩具项目，你还能对它有什么更高的要求呢？</p>
<p>下面，介绍 Sham 系统。</p>
<h2 id="Sham-系统概述"><a href="#Sham-系统概述" class="headerlink" title="Sham 系统概述"></a>Sham 系统概述</h2><p>在这里，简要介绍系统中的一些关键设计思路。</p>
<p>至于具体的实现，事实上，这个项目非常简单，而且我写了不少注释，在 git commit message 中也留下了（在我看来）较为详细的说明，如果您不介意，完全可以去读一读源码：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr/sham">https://github.com/cdfmlr/sham</a></li>
<li>备份：<a target="_blank" rel="noopener" href="https://gitee.com/cdfmlr/sham">https://gitee.com/cdfmlr/sham</a></li>
</ul>
<p>当然，如果你喜欢这个项目，欢迎 Star、Fork、Watch 三连。如果有任何疑问、意见或建议，也欢迎 Issue 和 PR。</p>
<h3 id="抽象结构"><a href="#抽象结构" class="headerlink" title="抽象结构"></a>抽象结构</h3><p>这个模拟的操作系统中，主要包含以下抽象：</p>
<ul>
<li>CPU：一个带有互斥锁的结构，单独在一个协程中运行应用程序的线程。</li>
<li>内存：一个无限大的结构，不需要管理。</li>
<li>IO设备：一个独立的设备，单独在一个协程中运行，可以输入或输出。</li>
<li>操作系统：包括操作系统基础结构、调度器、系统调用、中断处理程序组。为例简化模型，操作系统单独运行在一个协程中，它本身不需要在 CPU、内存上运行，而是在内部持有 CPU 和内存。<ul>
<li>操作系统基础结构：持有并管理 CPU，内存、IO 设备、进程表和中断向量。</li>
<li>调度器：完成进程调度工作的具体算法。</li>
<li>系统调用：为应用程序提供的“内核态”操作接口。</li>
<li>中断处理程序：处理应用程序或操作系统内部发出的各类中断。</li>
</ul>
</li>
<li>进程、线程：为了简化模型，一个进程只能持有且必须持有一个线程。<ul>
<li>进程：包括一个可运行的进程、当前状态（运行、就绪、阻塞）以及需要的各种资源（内存等）。</li>
<li>线程：进程具体可执行的部分，包含要运行的“程序代码”以及运行时的上下文。</li>
<li>上下文：包括程序计数器、进程指针、操作系统接口。</li>
</ul>
</li>
<li>具体应用程序：进程的实例（在 <a href="./sham_test.go">sham_test.go</a> 中实现了一些有意思的应用）。</li>
</ul>
<p>目前的实现中，调度器使用的是一个带时间片轮转的 FCFS 调度器，但可以十分容易地添加、替换新的调度算法。</p>
<h3 id="系统的工作流程"><a href="#系统的工作流程" class="headerlink" title="系统的工作流程"></a>系统的工作流程</h3><p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gknstu9g88j31e00u0dkx.jpg" alt="截屏2020-11-13 19.58.42"></p>
<h3 id="线程的运行"><a href="#线程的运行" class="headerlink" title="线程的运行"></a>线程的运行</h3><p>关于线程的运行，直接看一部分 Thread 具体代码实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Thread 线程：是一个可以在 CPU 里跑的东西。</span></span><br><span class="line"><span class="keyword">type</span> Thread <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// runnable 是实际要运行的内容</span></span><br><span class="line">	runnable Runnable</span><br><span class="line">	<span class="comment">// contextual 是 Thread 的环境</span></span><br><span class="line">	contextual *Contextual</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Runnable 程序：应用程序的具体的代码就写在这里面</span></span><br><span class="line"><span class="comment">// 每一次返回就代表“一条指令”（一个原子操作）执行完毕，返回值为状态：</span></span><br><span class="line"><span class="comment">//  - StatusRunning 继续运行（如果时间片未用尽）</span></span><br><span class="line"><span class="comment">//  - StatusReady 会进入就绪队列（即 yield，主动让出 CPU）</span></span><br><span class="line"><span class="comment">//  - StatusBlocked 会进入阻塞状态（一般不用。需要阻塞时一般通过中断请求）</span></span><br><span class="line"><span class="comment">//  - StatusDone 进程运行结束。</span></span><br><span class="line"><span class="keyword">type</span> Runnable <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 进程的状态</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	StatusBlocked = <span class="number">-1</span></span><br><span class="line">	StatusReady   = <span class="number">0</span></span><br><span class="line">	StatusRunning = <span class="number">1</span></span><br><span class="line">	StatusDone    = <span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Contextual 上下文：线程的上下文。</span></span><br><span class="line"><span class="keyword">type</span> Contextual <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 指向 Process 的指针，可以取用 Process 的资源</span></span><br><span class="line">	Process *Process</span><br><span class="line">	<span class="comment">// 通过 Contextual.OS.XX 调系统调用</span></span><br><span class="line">	OS OSInterface</span><br><span class="line">	<span class="comment">// 程序计数器</span></span><br><span class="line">	PC <span class="keyword">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的应用程序把“代码”写在一个 Runnable 型的函数中，这个函数每执行完一个原子操作就应该返回一次。同时 runnable 也可以在执行完任何一个原子操作时，被外部事件强行打断（比如时间片用尽）。</p>
<p> <code>Thread.Run()</code>  实现了上述控制，runnable 的返回、外部的打断都会被 <code>Thread.Run()</code> 捕获。前面的流程图中，「CPU 运行线程」也就是调用 <code>Thread.Run()</code> 方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run 包装并运行 Thread 的 runnable。</span></span><br><span class="line"><span class="comment">// 该函数返回的 done、cancel 让 runnable 变得可控：</span></span><br><span class="line"><span class="comment">// - 当 runnable 返回，即 Thread 结束时，done 会接收到 Process/Thread 的状态。</span></span><br><span class="line"><span class="comment">// - 当外部需要强制终止 runnable 的运行（调度），调用 cancel() 即可。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Thread)</span> <span class="title">Run</span><span class="params">()</span> <span class="params">(done <span class="keyword">chan</span> <span class="keyword">int</span>, cancel context.CancelFunc)</span></span> &#123;</span><br><span class="line">	done = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	_ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123; <span class="comment">// 一条条代码不停跑，直到阻塞｜退出｜被取消</span></span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> &lt;-_ctx.Done(): <span class="comment">// 被取消，取消由 CPU 发起</span></span><br><span class="line">                <span class="comment">// 取消时 CPU 会临时置 Status 为需要转到的状态，</span></span><br><span class="line">				<span class="comment">// 这里获取并把这个值传给操作系统</span></span><br><span class="line">				<span class="comment">// 同时把状态重置为 StatusRunning</span></span><br><span class="line">                <span class="comment">//（状态转化需由操作系统完成，这里只是暂时借用这个值，故要还原）</span></span><br><span class="line">				s := t.contextual.Process.Status</span><br><span class="line">				t.contextual.Process.Status = StatusRunning</span><br><span class="line">				done &lt;- s</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				ret := t.runnable(t.contextual)</span><br><span class="line">                t.contextual.Commit()  <span class="comment">// PC++, clockTick()</span></span><br><span class="line">				<span class="keyword">if</span> ret != StatusRunning &#123; <span class="comment">// 结束|阻塞|就绪，交给调度器处理</span></span><br><span class="line">					done &lt;- ret</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> done, cancel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用 go 语言标准库的 context 包，控制线程运行的取消（外部打断）。如果没有外部打断，runnable 返回时就会将程序计数器和时钟加一。如果 runnable 一直返回 StatusRunning 就可以一直运行下去。在 runnable 内部，通过 <code>contextual.PC</code> 以及例如 <code>switch</code> 的流程控制语句即可实现一条条代码执行的效果。</p>
<p>例如，下面的这个 Runnable 函数（程序）有 4 个操作（4 条指令）它们会依次执行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processSeq</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> contextual.PC &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        log.Debug(<span class="string">&quot;Line 0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        log.Debug(<span class="string">&quot;Line 1&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        log.Debug(<span class="string">&quot;Line 2&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> StatusDone</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的写法有些像汇编语言，而事实上，runnable 甚至就是这个模拟的操作系统的机器语言！所以写起来略为繁琐，这个难以避免。</p>
<p>运行的效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkndrmwyhcj31hm09sn1b.jpg" alt="截屏2020-11-13 11.21.54"></p>
<p><strong>注</strong>：把上面的程序翻译成我们平时的 Go 程序就是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">func <span class="title">processSeq</span><span class="params">()</span> <span class="keyword">int</span> </span>&#123;</span><br><span class="line">    <span class="built_in">log</span>.Debug(<span class="string">&quot;Line 0&quot;</span>)</span><br><span class="line">	<span class="built_in">log</span>.Debug(<span class="string">&quot;Line 1&quot;</span>)</span><br><span class="line">	<span class="built_in">log</span>.Debug(<span class="string">&quot;Line 2&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="中断与-IO"><a href="#中断与-IO" class="headerlink" title="中断与 IO"></a>中断与 IO</h3><p>中断在操作系统中至关重要，所以这个模拟的操作系统也需要中断的实现。</p>
<p>这里对中断的建模如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Interrupt <span class="keyword">struct</span> &#123;</span><br><span class="line">	Typ     <span class="keyword">string</span></span><br><span class="line">	Handler InterruptHandler</span><br><span class="line">	Data    InterruptData</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// InterruptHandler 是「中断处理程序」</span></span><br><span class="line"><span class="keyword">type</span> InterruptHandler <span class="function"><span class="keyword">func</span><span class="params">(os *OS, data InterruptData)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// InterruptData 是中断的数据</span></span><br><span class="line"><span class="keyword">type</span> InterruptData <span class="keyword">struct</span> &#123;</span><br><span class="line">	Pid <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Channel 是用来给中断发起程序与中断处理程序通信的信道。</span></span><br><span class="line">	Channel <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中断包含一个类型，处理程序（处理程序和中断类型一一对应），以及附加的数据。</p>
<p>应用程序，或操作系统内部都可以通过一个<strong>系统调用</strong>发出中断（这个模拟中几乎没有硬件，所以不考虑硬件中断）。操作系统受到中断请求，会把中断放入一个中断表，然后在当前时钟周期结束后，调度运行时程序阻塞，依次调用相应中断处理程序处理中断表里的中断。</p>
<p>中断处理程序会做必要的工作，完成后解除发起进程的阻塞状态。</p>
<p>有了这个中断机制，就可以很容易地实现时间片轮转——在时间片用尽后，发出一个时钟中断，其处理程序会把进程就绪。</p>
<p>同时，中断支持了各种 IO 设备的使用。例如，最简单的是使用标准输出，发出一个标准输出的中断请求，传入需要的数据即可：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">helloWorld</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">    ch &lt;- <span class="string">&quot;Hello, world!&quot;</span></span><br><span class="line">    contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                                   StdOutInterrupt, ch)</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个中断的处理程序会使用标准输出设备，完成输出。运行结果：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkndndoqc4j31jc0dk7au.jpg" alt="截屏2020-11-13 11.18.57"></p>
<p>出了标准输入，我还实现了标准输出设备，以及特殊的 Pipe 设备。这两个东西的调用代码都比较复杂，在此不做演示。</p>
<p>标准输入、输出都是模拟的“硬件”，这些东西会单独在一个协程中运行。而 Pipe 设备则是一个虚拟的设备，它是对 Go 语言 channel 的封装。操作系统可以动态生成任意多个 Pipe 并分配给需要的进程，通过 Pipe 进程之间就可以利用 CSP 模型可以完成通信与同步。</p>
<p>利用 Pipe 设备，在这个模拟的操作系统中，可以实现「生产者-消费者」问题。代码稍微复杂（需要约 150 行代码，见 <a href="./sham_test.go">sham_test.go</a> 之 TestProducerConsumer），但完全可以正确工作：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gknf17o30tj31jj0u0hbm.jpg" alt="截屏2020-11-13 12.07.16"></p>
<h2 id="Sham-程序设计"><a href="#Sham-程序设计" class="headerlink" title="Sham 程序设计"></a>Sham 程序设计</h2><p>作为系统可用性的<del>不严谨</del>证明，下面给出一份 Sham 程序设计指南。</p>
<p>在 Sham 源码的 <a target="_blank" rel="noopener" href="https://github.com/cdfmlr/sham/blob/master/sham_test.go">sham_test.go</a> 文件中，包含了一系列开发过程中测试使用的应用程序实现。我们完全可以把这个文章看作 Sham 程序设计的官方实例。下文中任何不明朗部分都请参考那些实例。</p>
<h3 id="如何运行-Sham"><a href="#如何运行-Sham" class="headerlink" title="如何运行 Sham?"></a>如何运行 Sham?</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">shamOS := NewOS()</span><br><span class="line">shamOS.Scheduler = FCFSScheduler&#123;&#125;</span><br><span class="line"><span class="comment">// shamOS.ReadyProcs = []*Process&#123;&#125; // No Noop</span></span><br><span class="line"></span><br><span class="line">shamOS.CreateProcess(...)</span><br><span class="line">shamOS.CreateProcess(...)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">shamOS.Boot()</span><br></pre></td></tr></table></figure>

<p>获取一个 OS 实例，指定调度器（FCFSScheduler 是先来先服务算法），添加应用程序进程，然后 Boot 就开始运行了！</p>
<p>系统的就绪队列中默认有一个 Noop（NO OPeration）进程，这个进程什么也不做。如果不需要，可以参考被注释掉的第三行代码删除它。</p>
<p>调用 <code>shamOS.CreateProcess</code> 可以给系统中新建进程，新的进程会被正确初始化，并放入就绪队列等待运行：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(os *OS)</span> <span class="title">CreateProcess</span><span class="params">(pid <span class="keyword">string</span>, precedence <span class="keyword">uint</span>, timeCost <span class="keyword">uint</span>, runnable Runnable)</span></span></span><br></pre></td></tr></table></figure>

<p>precedence 和 timeCost 是给留特定的调度算法使用的，如果使用 FCFSScheduler 就没什么用，随便写即可，runnable 就是具体的程序代码了，下面就介绍 runnable 的写法。</p>
<h3 id="顺序程序"><a href="#顺序程序" class="headerlink" title="顺序程序"></a>顺序程序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processSeq</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> contextual.PC &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        log.Debug(<span class="string">&quot;Line 0&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        log.Debug(<span class="string">&quot;Line 1&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        log.Debug(<span class="string">&quot;Line 2&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> StatusDone</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>借助 <code>switch contextual.PC</code> 和 <code>return StatusRunning</code> 一个时钟执行一个操作。当程序结束时，<code>return StatusDone</code>。</p>
<p>注：这里是调用了 log（github.com/sirupsen/logrus，打一条日志），这其实是个「超系统调用」，调用了 sham 以外的东西。作为测试，这没问题。</p>
<h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>如果你对刚才的「超系统调用」感觉不爽，那没关系，下面就介绍 Sham 的系统调用。其实之前我们使用的 <code>CreateProcess</code> 就是一个系统调用：</p>
<ul>
<li><code>CreateProcess(pid string, precedence uint, timeCost uint, runnable Runnable)</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shamOS.CreateProcess(<span class="string">&quot;processFoo&quot;</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    contextual.OS.CreateProcess(<span class="string">&quot;ProcessBar&quot;</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;ProcessBar, a Process dynamic created by processFoo&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> StatusDone</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>我们使用 <code>contextual.OS.XXX</code> 完成系统调用。这里 processFoo 调用 <code>CreateProcess</code> 新建了一个进程 ProcessBar。 </p>
<p>还有一个更有用的系统调用——中断请求：</p>
<ul>
<li><code>InterruptRequest(thread *Thread, typ string, channel chan interface&#123;&#125;)</code></li>
</ul>
<p>thread 是发起中断的进程，一般是当前线程自己： <code>contextual.Process.Thread</code> ，typ 是要调用的中断类型，channel 是当前线程与中断处理程序直接通信的。</p>
<p>由于当前线程与中断处理程序显然不同步，channel 必须是带缓冲区的！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">helloWorld</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">    ch &lt;- <span class="string">&quot;Hello, world!&quot;</span></span><br><span class="line">    contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                                   StdOutInterrupt, ch)</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前可用的中断类型有：</p>
<table>
<thead>
<tr>
<th>typ</th>
<th>说明</th>
<th>channel</th>
</tr>
</thead>
<tbody><tr>
<td><code>StdOutInterrupt</code></td>
<td>输出到标准输出</td>
<td>放入药输出的东西</td>
</tr>
<tr>
<td><code>StdInInterrupt</code></td>
<td>从标准输入获取输入</td>
<td>一个空 chan，标准输入会写东西进去</td>
</tr>
<tr>
<td><code>NewPipeInterrupt</code></td>
<td>新建一个 Pipe 设备</td>
<td>放入 pipeID 和 pipeBufferSize</td>
</tr>
<tr>
<td><code>GetPipeInterrupt</code></td>
<td>获取一个 Pipe 设备</td>
<td>放入 pipeID</td>
</tr>
</tbody></table>
<p>关于 Pipe 后面再详细介绍。</p>
<p>使用标准输入时，需要注意，把 chan 放到 sham 线程的内存中，而不是使用一个 go 变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">shamOS.CreateProcess(<span class="string">&quot;processIn&quot;</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    mem := &amp;contextual.Process.Memory[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> contextual.PC &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        in := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">        <span class="comment">// in 会在多个周期中被使用，需要放入内存</span></span><br><span class="line">        mem.Content = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;in&quot;</span>: in&#125;</span><br><span class="line">        contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                                       StdInInterrupt, in)</span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        in := mem.Content.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)[<span class="string">&quot;in&quot;</span>]</span><br><span class="line"></span><br><span class="line">        content := &lt;-in</span><br><span class="line">        log.WithField(<span class="string">&quot;content&quot;</span>, content).Debug(<span class="string">&quot;got content&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> StatusDone</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="变量使用"><a href="#变量使用" class="headerlink" title="变量使用"></a>变量使用</h3><p>程序中当然是需要使用变量的。但从刚才的标准输出程序可以看到，使用 sham 的内存极为麻烦！而那些从内存读写变量的操作非常套路化，所以我封装了一个 <code>VarPool</code> 来方便变量读写：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">contextual.InitVarPool()  <span class="comment">// 初始化变量池</span></span><br><span class="line">contextual.SetVar(<span class="string">&quot;varName&quot;</span>, something)  <span class="comment">// 放入（新建或更新）变量</span></span><br><span class="line">something := contextual.GetVar(<span class="string">&quot;varName&quot;</span>)  <span class="comment">// 读取变量，如果不存在会得到 nil</span></span><br><span class="line">something, ok := contextual.TryGetVar(<span class="string">&quot;varName&quot;</span>)  <span class="comment">// 读取变量，ok指使变量是否存在</span></span><br></pre></td></tr></table></figure>

<p>E.g.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">shamOS.CreateProcess(<span class="string">&quot;useVarPool&quot;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> contextual.PC == <span class="number">0</span>:</span><br><span class="line">        contextual.InitVarPool()</span><br><span class="line">        </span><br><span class="line">        contextual.SetVar(<span class="string">&quot;chOutput&quot;</span>, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> contextual.PC &lt;= <span class="number">3</span>:</span><br><span class="line">        contextual.SetVar(<span class="string">&quot;num&quot;</span>, contextual.PC*contextual.PC)</span><br><span class="line"></span><br><span class="line">        chOut := contextual.GetVar(<span class="string">&quot;chOutput&quot;</span>).(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">        </span><br><span class="line">        chOut &lt;- fmt.Sprintln(contextual.GetVar(<span class="string">&quot;num&quot;</span>), chOut)</span><br><span class="line">        contextual.OS.InterruptRequest(contextual.Process.Thread, StdOutInterrupt, chOut)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="条件-循环"><a href="#条件-循环" class="headerlink" title="条件/循环"></a>条件/循环</h3><p>条件、循环这里做的不太好，比较麻烦。需要大家手动维护额外的程序计数器：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PipeProduct = <span class="string">&quot;pipe_product&quot;</span></span><br><span class="line"></span><br><span class="line">shamOS.CreateProcess(<span class="string">&quot;producer&quot;</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> contextual.PC &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        contextual.InitVarPool()</span><br><span class="line">        contextual.SetVar(<span class="string">&quot;chOutput&quot;</span>, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        pipeArgs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line">        pipeArgs &lt;- PipeProduct <span class="comment">// pipeId</span></span><br><span class="line">        pipeArgs &lt;- <span class="number">3</span>           <span class="comment">// pipeBufferSize</span></span><br><span class="line">        contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                                       NewPipeInterrupt, pipeArgs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> contextual.PC &gt; <span class="number">30</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> StatusDone</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _, ok := contextual.TryGetVar(<span class="string">&quot;dpc&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            contextual.SetVar(<span class="string">&quot;dpc&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        dpc := contextual.GetVar(<span class="string">&quot;dpc&quot;</span>).(<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> dpc &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            product := contextual.PC</span><br><span class="line"></span><br><span class="line">            contextual.SetVar(<span class="string">&quot;product&quot;</span>, product)</span><br><span class="line"></span><br><span class="line">            contextual.SetVar(<span class="string">&quot;dpc&quot;</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> StatusRunning</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            pipe := <span class="keyword">interface</span>&#123;&#125;(</span><br><span class="line">                contextual.Process.Devices[PipeProduct]).(*Pipe)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pipe.Inputable() &#123;</span><br><span class="line">                product := contextual.GetVar(<span class="string">&quot;product&quot;</span>)</span><br><span class="line"></span><br><span class="line">                pipe.Input() &lt;- product</span><br><span class="line"></span><br><span class="line">                contextual.SetVar(<span class="string">&quot;dpc&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> StatusReady <span class="comment">// yield</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> StatusRunning</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这段代码是生产者消费者问题中的生产者线程，我们通过一个 <code>dpc</code> 变量实现了类似于 <code>JMP</code> 指令的跳转功能。</p>
<p>这段代码中关于 Pipe 不太好理解，所以下面介绍 Pipe。</p>
<h3 id="进程通信-Pipe"><a href="#进程通信-Pipe" class="headerlink" title="进程通信: Pipe"></a>进程通信: Pipe</h3><p>Pipe 是 Sham 中的一种特殊 IO 设备，它是对 Golang chan 的封装，它提供了 Sham 进程间通信的能力。</p>
<p>创建 Pipe：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pipeArgs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line">pipeArgs &lt;- <span class="string">&quot;pipeID&quot;</span>  <span class="comment">// pipeId</span></span><br><span class="line">pipeArgs &lt;- <span class="number">3</span>         <span class="comment">// pipeBufferSize</span></span><br><span class="line">contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                               NewPipeInterrupt, pipeArgs)</span><br></pre></td></tr></table></figure>

<p>其他进程获取 Pipe：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pipeArgs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line">pipeArgs &lt;- <span class="string">&quot;pipeID&quot;</span> <span class="comment">// pipeId</span></span><br><span class="line"></span><br><span class="line">contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                               GetPipeInterrupt, pipeArgs)</span><br></pre></td></tr></table></figure>

<p><code>NewPipeInterrupt</code> 和 <code>GetPipeInterrupt</code> 中断请求被成功处理之后，操作系统会把新建的/获取到的 Pipe 分配给进程，通过 contextual 可以获取：<code>contextual.Process.Devices[&quot;pipeID&quot;]</code>。我们会获取到一个 Device 类型的东西，为了具体使用时方便，我们需要把它转化为 *Pipe 类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipe := <span class="keyword">interface</span>&#123;&#125;(contextual.Process.Devices[PipeProduct]).(*Pipe)</span><br></pre></td></tr></table></figure>

<p>在读写 Pipe 的时候需要注意边界条件，不可读时强行去读会造成死锁。</p>
<p>写：在 <code>pipe.Inputable()</code> 时 <code>pipe.Input() &lt;- something</code>，否则说明阻塞，主动让出 CPU：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> pipe.Inputable() &#123;</span><br><span class="line">    pipe.Input() &lt;- contextual.GetVar(<span class="string">&quot;product&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> StatusReady <span class="comment">// yield</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读也是类似的，检测—读取—否则让出 CPU：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> pipe.Outputable() &#123;</span><br><span class="line">    contextual.SetVar(<span class="string">&quot;product&quot;</span>, &lt;-pipe.Output())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> StatusReady <span class="comment">// yield</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文章结束之前"><a href="#文章结束之前" class="headerlink" title="文章结束之前"></a>文章结束之前</h2><p>无论您是技术比我强的大佬，或是在某一方面比我稍弱的同学，看到这里可能都会骂一声——“什么东西？”</p>
<p>为了回答您的疑问，我想重述我对 Sham 的定义：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/cdfmlr/sham">cdfmlr/sham</a> （sham 意为：骗局、虚假事物）：一个拥有标准输入输出与进程间通信的、基于时间片轮转调度的多道程序运行器。</p>
</blockquote>
<p>这是我在学习操作系统时的个人娱乐作品。它的功能、整体设计、代码细节都做的很差，因为它最初的设计，仅是为了开玩笑写出的 200 余个字符：</p>
<p><img src="https://tva1.sinaimg.cn/large/0081Kckwly1gkrbyvn0lkj30u0145gx2.jpg" alt="截屏2020-11-16 21.23.28"></p>
<p>如果您喜欢这个项目，欢迎 Star、Fork 和 PR。如果您不喜欢这东西，或有任何看法、疑问、意见或建议，也欢迎 Issue，望不吝赐教为感！</p>
<hr>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shamOS := NewOS()</span><br><span class="line">shamOS.Scheduler = FCFSScheduler&#123;&#125;</span><br><span class="line">shamOS.ReadyProcs = []*Process&#123;&#125;</span><br><span class="line"></span><br><span class="line">shamOS.CreateProcess(<span class="string">&quot;SeeYou&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="function"><span class="keyword">func</span><span class="params">(contextual *Contextual)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    eof := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">1</span>)</span><br><span class="line">    eof &lt;- <span class="string">&quot;By CDFMLR \n 2020.11.16&quot;</span></span><br><span class="line">    contextual.OS.InterruptRequest(contextual.Process.Thread, </span><br><span class="line">                                   StdOutInterrupt, eof)</span><br><span class="line">    <span class="keyword">return</span> StatusDone</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">shamOS.Boot()</span><br></pre></td></tr></table></figure>


  </div>
</article>
<!--Disqus-->


<!--Livere-->

    <div class="blog-post-comments">
        <div id="lv-container" data-id="city" data-uid="MTAyMC80NjEzMi8yMjY0Mw==">
            <noscript>不启用 JavaScript 支持的人是看不到可爱的评论区的。😥</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introducing-Sham"><span class="toc-number">1.</span> <span class="toc-text">Introducing: Sham</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B7%E5%9B%A0"><span class="toc-number">1.1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sham-%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">Sham 系统概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">抽象结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">系统的工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%9A%84%E8%BF%90%E8%A1%8C"><span class="toc-number">1.2.3.</span> <span class="toc-text">线程的运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E4%B8%8E-IO"><span class="toc-number">1.2.4.</span> <span class="toc-text">中断与 IO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sham-%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.</span> <span class="toc-text">Sham 程序设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BF%90%E8%A1%8C-Sham"><span class="toc-number">1.3.1.</span> <span class="toc-text">如何运行 Sham?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%BA%E5%BA%8F%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text">顺序程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E4%BD%BF%E7%94%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text">变量使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6-%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.3.5.</span> <span class="toc-text">条件&#x2F;循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1-Pipe"><span class="toc-number">1.3.6.</span> <span class="toc-text">进程通信: Pipe</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E7%BB%93%E6%9D%9F%E4%B9%8B%E5%89%8D"><span class="toc-number">1.4.</span> <span class="toc-text">文章结束之前</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://clownote.github.io/2020/11/16/blog/Intro_sham/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&text=Introducing Sham"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&is_video=false&description=Introducing Sham"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Introducing Sham&body=Check out this article: https://clownote.github.io/2020/11/16/blog/Intro_sham/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&title=Introducing Sham"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://clownote.github.io/2020/11/16/blog/Intro_sham/&name=Introducing Sham&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2022 CDFMLR
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-146911386-1', 'auto');
        ga('send', 'pageview');
    </script>
    
    <!-- New: global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146911386-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-146911386-1');
    </script>
    

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?9a0d2e6fde93dad496ac79f04f3aba97";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


<!--Livere Comments-->

    <script type="text/javascript">
      (function (d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>


</body>
</html>
