<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Lab: page tables MIT 6.S081 Xv6-riscv Lab 3: https:&#x2F;&#x2F;pdos.csail.mit.edu&#x2F;6.S081&#x2F;2020&#x2F;labs&#x2F;pgtbl.html  Print a page tableDefine a function called vmprint(). It should take a pagetable_t argument, and p">
<meta property="og:type" content="article">
<meta property="og:title" content="Xv6 Lab page tables">
<meta property="og:url" content="https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/index.html">
<meta property="og:site_name" content="clownote">
<meta property="og:description" content="Lab: page tables MIT 6.S081 Xv6-riscv Lab 3: https:&#x2F;&#x2F;pdos.csail.mit.edu&#x2F;6.S081&#x2F;2020&#x2F;labs&#x2F;pgtbl.html  Print a page tableDefine a function called vmprint(). It should take a pagetable_t argument, and p">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://api.ixiaowai.cn/api/api.php">
<meta property="article:published_time" content="2021-03-11T08:25:22.131Z">
<meta property="article:modified_time" content="2022-10-03T07:17:11.686Z">
<meta property="article:author" content="CDFMLR">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://api.ixiaowai.cn/api/api.php">
    
    
        
          
              <link rel="shortcut icon" href="/images/rabbit.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/rabbit_192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/rabbit_180.png">
          
        
    
    <!-- title -->
    <title>Xv6 Lab page tables</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
    <!--Google search varification (PRIVATE)-->
    <meta name="google-site-verification" content="MrqlpFAD8nDanw3Ypv7ZsIWHLnTdhRuLa4QhSVwxIvc" />
    <!--Google AdSense 关联 (PRIVATE)-->
    <script data-ad-client="ca-pub-1510963483941114" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/03/16/xv6/Xv6-traps-and-system-calls/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/03/06/xv6/Xv6-page-table/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&text=Xv6 Lab page tables"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&is_video=false&description=Xv6 Lab page tables"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Xv6 Lab page tables&body=Check out this article: https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&name=Xv6 Lab page tables&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-page-tables"><span class="toc-number">1.</span> <span class="toc-text">Lab: page tables</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Print-a-page-table"><span class="toc-number">1.1.</span> <span class="toc-text">Print a page table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">主要实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E7%9A%84diff"><span class="toc-number">1.1.2.</span> <span class="toc-text">详细的diff</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-kernel-page-table-per-process"><span class="toc-number">1.2.</span> <span class="toc-text">A kernel page table per process</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">主要实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diff"><span class="toc-number">1.2.2.</span> <span class="toc-text">Diff</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Simplify-copyin-copyinstr"><span class="toc-number">1.3.</span> <span class="toc-text">Simplify copyin&#x2F;copyinstr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">主要实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diff-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">Diff</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">1.4.</span> <span class="toc-text">最后</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Xv6 Lab page tables
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">clownote</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-03-11T08:25:22.131Z" itemprop="datePublished">2021-03-11</time>
        
        (Updated: <time datetime="2022-10-03T07:17:11.686Z" itemprop="dateModified">2022-10-03</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/xv6/" rel="tag">xv6</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://api.ixiaowai.cn/api/api.php" alt="Meaning Unknown&#39;s Head Image"></p>
<h1 id="Lab-page-tables"><a href="#Lab-page-tables" class="headerlink" title="Lab: page tables"></a>Lab: page tables</h1><blockquote>
<p>MIT 6.S081 Xv6-riscv Lab 3: <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2020/labs/pgtbl.html">https://pdos.csail.mit.edu/6.S081/2020/labs/pgtbl.html</a></p>
</blockquote>
<h2 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h2><p>Define a function called <code>vmprint()</code>. It should take a <code>pagetable_t</code> argument, and print that pagetable in the format described below. Insert <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> in exec.c just before the <code>return argc</code>, to print the first process’s page table. You receive full credit for this assignment if you pass the <code>pte printout</code> test of <code>make grade</code>.</p>
<h3 id="主要实现"><a href="#主要实现" class="headerlink" title="主要实现"></a>主要实现</h3><p>这题就递归打印一下地址，非常容易了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_pteprint(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">int</span> level)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte = pagetable[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pte &amp; PTE_V) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= level; j++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;.. &quot;</span>);</span><br><span class="line">      <span class="comment">// printf(&quot;\b%d: pte %p pa %p\n&quot;, i, pte, PTE2PA(pte));</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: pte %p pa %p\n&quot;</span>, i, pte, PTE2PA(pte));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((pte &amp; PTE_V) &amp;&amp; (pte &amp; (PTE_R|PTE_W|PTE_W)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// this PTE points to a lower-level page table.</span></span><br><span class="line">    uint64 child = PTE2PA(pte);</span><br><span class="line">    _pteprint((<span class="keyword">pagetable_t</span>)child, level+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">vmprint(<span class="keyword">pagetable_t</span> pagetable)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pagetable);</span><br><span class="line">  _pteprint(pagetable, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注，_pteprint 里的 printf 那里带上 <code>\b</code> 打印出来效果和题目一样了，但通不过make grade —— <code>\b</code> 也是个字符哦: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat -vte xv6.out.pteprint:</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">page table 0x0000000087f6e000$</span><br><span class="line">.. ^H0: pte 0x0000000021fda801 pa 0x0000000087f6a000$</span><br><span class="line">.. .. ^H0: pte 0x0000000021fda401 pa 0x0000000087f69000$</span><br><span class="line">.. .. .. ^H0: pte 0x0000000021fdac1f pa 0x0000000087f6b000$</span><br><span class="line">.. .. .. ^H1: pte 0x0000000021fda00f pa 0x0000000087f68000$</span><br><span class="line">.. .. .. ^H2: pte 0x0000000021fd9c1f pa 0x0000000087f67000$</span><br><span class="line">.. ^H255: pte 0x0000000021fdb401 pa 0x0000000087f6d000$</span><br><span class="line">.. .. ^H511: pte 0x0000000021fdb001 pa 0x0000000087f6c000$</span><br><span class="line">.. .. .. ^H510: pte 0x0000000021fdd807 pa 0x0000000087f76000$</span><br><span class="line">.. .. .. ^H511: pte 0x0000000020001c0b pa 0x0000000080007000$</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>但多个空格是可以过 make grade 测试的，所以就这样了。</p>
<h3 id="详细的diff"><a href="#详细的diff" class="headerlink" title="详细的diff"></a>详细的diff</h3><p>(patch)</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index a73b4f7..ebc4cad 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -178,6 +178,7 @@</span> uint64          walkaddr(pagetable_t, uint64);</span><br><span class="line"> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"><span class="addition">+void            vmprint(pagetable_t);</span></span><br><span class="line"> </span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/exec.c b/kernel/exec.c</span></span><br><span class="line"><span class="comment">index 0e8762f..4c41c7d 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/exec.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/exec.c</span></span><br><span class="line"><span class="meta">@@ -115,6 +115,9 @@</span> exec(char *path, char **argv)</span><br><span class="line">   p-&gt;trapframe-&gt;epc = elf.entry;  // initial program counter = main</span><br><span class="line">   p-&gt;trapframe-&gt;sp = sp; // initial stack pointer</span><br><span class="line">   proc_freepagetable(oldpagetable, oldsz);</span><br><span class="line"><span class="addition">+  </span></span><br><span class="line"><span class="addition">+  if (p-&gt;pid == 1)</span></span><br><span class="line"><span class="addition">+	  vmprint(p-&gt;pagetable);</span></span><br><span class="line"> </span><br><span class="line">   return argc; // this ends up in a0, the first argument to main(argc, argv)</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index bccb405..3487f25 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -440,3 +440,36 @@</span> copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span><br><span class="line">     return -1;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void</span></span><br><span class="line"><span class="addition">+_pteprint(pagetable_t pagetable, int level)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  for(int i = 0; i &lt; 512; i++) &#123;</span></span><br><span class="line"><span class="addition">+    pte_t pte = pagetable[i];</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    if (pte &amp; PTE_V) &#123;</span></span><br><span class="line"><span class="addition">+      for (int j = 0; j &lt;= level; j++)</span></span><br><span class="line"><span class="addition">+        printf(&quot;.. &quot;);</span></span><br><span class="line"><span class="addition">+      // printf(&quot;\b%d: pte %p pa %p\n&quot;, i, pte, PTE2PA(pte));</span></span><br><span class="line"><span class="addition">+    // 这里带上 \b 打印出来效果和题目一样了，但通不过make grade</span></span><br><span class="line"><span class="addition">+    // \b 也是个字符哦: cat -vte xv6.out.pteprint:</span></span><br><span class="line"><span class="addition">+    //   .. ^H0: pte 0xXXX pa 0xXXX$</span></span><br><span class="line"><span class="addition">+    // 多个空格是可以过 make grade 测试的</span></span><br><span class="line"><span class="addition">+      printf(&quot;%d: pte %p pa %p\n&quot;, i, pte, PTE2PA(pte));</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    if ((pte &amp; PTE_V) &amp;&amp; (pte &amp; (PTE_R|PTE_W|PTE_W)) == 0) &#123;</span></span><br><span class="line"><span class="addition">+        // this PTE points to a lower-level page table.</span></span><br><span class="line"><span class="addition">+    uint64 child = PTE2PA(pte);</span></span><br><span class="line"><span class="addition">+    _pteprint((pagetable_t)child, level+1);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void</span></span><br><span class="line"><span class="addition">+vmprint(pagetable_t pagetable)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  printf(&quot;page table %p\n&quot;, pagetable);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  _pteprint(pagetable, 0);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br></pre></td></tr></table></figure>



<h2 id="A-kernel-page-table-per-process"><a href="#A-kernel-page-table-per-process" class="headerlink" title="A kernel page table per process"></a>A kernel page table per process</h2><p>Your first job is to modify the kernel so that every process uses its own copy of the kernel page table when executing in the kernel. Modify <code>struct proc</code> to maintain a kernel page table for each process, and modify the scheduler to switch kernel page tables when switching processes. For this step, each per-process kernel page table should be identical to the existing global kernel page table. You pass this part of the lab if <code>usertests</code> runs correctly.</p>
<h3 id="主要实现-1"><a href="#主要实现-1" class="headerlink" title="主要实现"></a>主要实现</h3><p>跟着 hits 一步一步做。</p>
<ol>
<li>在 <code>struct proc</code> 里面加一个内核页表字段：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">  ...</span><br><span class="line">  uint64 kstack;             <span class="comment">// Virtual address of kernel stack</span></span><br><span class="line">  uint64 sz;                 <span class="comment">// Size of process memory (bytes)</span></span><br><span class="line">  <span class="keyword">pagetable_t</span> pagetable;     <span class="comment">// User page table</span></span><br><span class="line">  <span class="keyword">pagetable_t</span> kpagetable;    <span class="comment">// (+) Kernel page table</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>模仿 <code>kvminit</code> 实现一个构建内核页表映射的函数，后面每个进程都调这个函数构建一分内核页表：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * make a direct-map page table for the kernel.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">pagetable_t</span></span><br><span class="line">kvmmake()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">pagetable_t</span> kpagetable = (<span class="keyword">pagetable_t</span>) kalloc();</span><br><span class="line">  <span class="built_in">memset</span>(kpagetable, <span class="number">0</span>, PGSIZE);</span><br><span class="line">  kvmmap(kpagetable, UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">  kvmmap(kpagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">  kvmmap(kpagetable, CLINT, CLINT, <span class="number">0x10000</span>, PTE_R | PTE_W);</span><br><span class="line">  kvmmap(kpagetable, PLIC, PLIC, <span class="number">0x400000</span>, PTE_R | PTE_W);</span><br><span class="line">  kvmmap(kpagetable, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line">  kvmmap(kpagetable, (uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span><br><span class="line">  kvmmap(kpagetable, TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> kpagetable;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * setup kernel_pagetable</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">kvminit()</span><br><span class="line">&#123;</span><br><span class="line">  kernel_pagetable = kvmmake();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加一个 pagetable_t 参数</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">kvmmap(<span class="keyword">pagetable_t</span> kpagetable, uint64 va, uint64 pa, uint64 sz, <span class="keyword">int</span> perm)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(mappages(kpagetable, va, sz, pa, perm) != <span class="number">0</span>)</span><br><span class="line">    panic(<span class="string">&quot;kvmmap&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在 <code>allocproc</code> 里用上面的 kvmmake 方法得到自己的内核页表，同时把原本在 <code>procinit</code> 里做的 kernel stack 映射改到 allocproc 来：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize the proc table at boot time.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">procinit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  </span><br><span class="line">  initlock(&amp;pid_lock, <span class="string">&quot;nextpid&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">      initlock(&amp;p-&gt;lock, <span class="string">&quot;proc&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// kvminithart();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>*</span></span><br><span class="line"><span class="class"><span class="title">allocproc</span>(<span class="title">void</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ...</span><br><span class="line">found:</span><br><span class="line">  p-&gt;pid = allocpid();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate a trapframe page.</span></span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// (+) A kernel page table</span></span><br><span class="line">  <span class="keyword">if</span>((p-&gt;kpagetable = kvmmake()) == <span class="number">0</span>)&#123;</span><br><span class="line">  	freeproc(p);</span><br><span class="line">	release(&amp;p-&gt;lock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// (+) Allocate a page for the process&#x27;s kernel stack.</span></span><br><span class="line">  <span class="comment">// Map it high in memory, followed by an invalid</span></span><br><span class="line">  <span class="comment">// guard page.</span></span><br><span class="line">  <span class="keyword">char</span> *pa = kalloc();</span><br><span class="line">  <span class="keyword">if</span>(pa == <span class="number">0</span>)</span><br><span class="line">	panic(<span class="string">&quot;kalloc&quot;</span>);</span><br><span class="line">  uint64 va = KSTACK((<span class="keyword">int</span>)(p - proc));</span><br><span class="line">  <span class="comment">// uint64 va = KSTACK(0);</span></span><br><span class="line">  kvmmap(p-&gt;kpagetable, va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">  p-&gt;kstack = va;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// An empty user page table.</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>改 <code>scheduler()</code>, swtch 到新进程前把 <code>satp</code> 设置为新进程的内核页表，没运行进程的时候用 <code>kernel_pagetable</code>：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">scheduler(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">      acquire(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">if</span>(p-&gt;state == RUNNABLE) &#123;</span><br><span class="line">        p-&gt;state = RUNNING;</span><br><span class="line">        c-&gt;proc = p;</span><br><span class="line"></span><br><span class="line">		w_satp(MAKE_SATP(p-&gt;kpagetable));  <span class="comment">// (+)</span></span><br><span class="line">		sfence_vma();  <span class="comment">// (+)</span></span><br><span class="line"></span><br><span class="line">        swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process is done running for now.</span></span><br><span class="line">        <span class="comment">// It should have changed its p-&gt;state before coming back.</span></span><br><span class="line">        c-&gt;proc = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// use kernel_pagetable when no process is running.</span></span><br><span class="line">		kvminithart();  <span class="comment">// (+)</span></span><br><span class="line"></span><br><span class="line">        found = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined (LAB_FS)</span></span><br><span class="line">...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在 <code>freeproc</code> 里面释放进程内核页表，注意不要释放物理内存：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">freeproc(struct proc *p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;trapframe)</span><br><span class="line">    kfree((<span class="keyword">void</span>*)p-&gt;trapframe);</span><br><span class="line">  p-&gt;trapframe = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// (+)👇</span></span><br><span class="line">  <span class="keyword">if</span>(p-&gt;kstack)</span><br><span class="line">	uvmunmap(p-&gt;kpagetable, p-&gt;kstack, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  p-&gt;kstack = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;kpagetable)</span><br><span class="line">	kvmfree(p-&gt;kpagetable);</span><br><span class="line">  p-&gt;kpagetable = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// (+)👆</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(p-&gt;pagetable)</span><br><span class="line">    proc_freepagetable(p-&gt;pagetable, p-&gt;sz);</span><br><span class="line">  p-&gt;pagetable = <span class="number">0</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>kvmfree</code> 模仿 freewalk，释放内核页表:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">kvmfree(<span class="keyword">pagetable_t</span> kpgtbl) &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> pte = kpgtbl[i];</span><br><span class="line">    <span class="keyword">if</span> (pte &amp; PTE_V)&#123;</span><br><span class="line">		kpgtbl[i] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> ((pte &amp; (PTE_R|PTE_W|PTE_X)) == <span class="number">0</span>) &#123;</span><br><span class="line">		  uint64 child = PTE2PA(pte);</span><br><span class="line">		  kvmfree((<span class="keyword">pagetable_t</span>)child);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pte &amp; PTE_V)&#123;</span><br><span class="line">      panic(<span class="string">&quot;kvmfree: leaf&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree((<span class="keyword">void</span>*)kpgtbl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>最后，在 vm.c 有个 kvmpa，要改成用当前进程的内核页表的：导入 proc.h, 从 myproc 获取内核页表：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;spinlock.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;proc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">uint64</span><br><span class="line">kvmpa(uint64 va)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  pte = walk(myproc()-&gt;kpagetable, va, <span class="number">0</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Diff"><a href="#Diff" class="headerlink" title="Diff"></a>Diff</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index ebc4cad..6a85a85 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -92,6 +92,7 @@</span> int             fork(void);</span><br><span class="line"> int             growproc(int);</span><br><span class="line"> pagetable_t     proc_pagetable(struct proc *);</span><br><span class="line"> void            proc_freepagetable(pagetable_t, uint64);</span><br><span class="line"><span class="addition">+// void            proc_freekpagetable(pagetable_t, uint64, uint64);</span></span><br><span class="line"> int             kill(int);</span><br><span class="line"> struct cpu*     mycpu(void);</span><br><span class="line"> struct cpu*     getmycpu(void);</span><br><span class="line"><span class="meta">@@ -161,7 +162,7 @@</span> int             uartgetc(void);</span><br><span class="line"> void            kvminit(void);</span><br><span class="line"> void            kvminithart(void);</span><br><span class="line"> uint64          kvmpa(uint64);</span><br><span class="line"><span class="deletion">-void            kvmmap(uint64, uint64, uint64, int);</span></span><br><span class="line"><span class="addition">+void            kvmmap(pagetable_t, uint64, uint64, uint64, int);</span></span><br><span class="line"> int             mappages(pagetable_t, uint64, uint64, uint64, int);</span><br><span class="line"> pagetable_t     uvmcreate(void);</span><br><span class="line"> void            uvminit(pagetable_t, uchar *, uint);</span><br><span class="line"><span class="meta">@@ -179,6 +180,8 @@</span> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> void            vmprint(pagetable_t);</span><br><span class="line"><span class="addition">+pagetable_t     kvmmake(void);</span></span><br><span class="line"><span class="addition">+void            kvmfree(pagetable_t);</span></span><br><span class="line"> </span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index dab1e1d..d731950 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -34,14 +34,16 @@</span> procinit(void)</span><br><span class="line">       // Allocate a page for the process&#x27;s kernel stack.</span><br><span class="line">       // Map it high in memory, followed by an invalid</span><br><span class="line">       // guard page.</span><br><span class="line"><span class="addition">+	  /*</span></span><br><span class="line">       char *pa = kalloc();</span><br><span class="line">       if(pa == 0)</span><br><span class="line">         panic(&quot;kalloc&quot;);</span><br><span class="line">       uint64 va = KSTACK((int) (p - proc));</span><br><span class="line">       kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">       p-&gt;kstack = va;</span><br><span class="line"><span class="addition">+	  */</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="deletion">-  kvminithart();</span></span><br><span class="line"><span class="addition">+  // kvminithart();</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // Must be called with interrupts disabled,</span><br><span class="line"><span class="meta">@@ -112,6 +114,24 @@</span> found:</span><br><span class="line">     release(&amp;p-&gt;lock);</span><br><span class="line">     return 0;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+  </span></span><br><span class="line"><span class="addition">+  // A kernel page table</span></span><br><span class="line"><span class="addition">+  if((p-&gt;kpagetable = kvmmake()) == 0)&#123;</span></span><br><span class="line"><span class="addition">+  	freeproc(p);</span></span><br><span class="line"><span class="addition">+	release(&amp;p-&gt;lock);</span></span><br><span class="line"><span class="addition">+	return 0;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // Allocate a page for the process&#x27;s kernel stack.</span></span><br><span class="line"><span class="addition">+  // Map it high in memory, followed by an invalid</span></span><br><span class="line"><span class="addition">+  // guard page.</span></span><br><span class="line"><span class="addition">+  char *pa = kalloc();</span></span><br><span class="line"><span class="addition">+  if(pa == 0)</span></span><br><span class="line"><span class="addition">+	panic(&quot;kalloc&quot;);</span></span><br><span class="line"><span class="addition">+  uint64 va = KSTACK((int)(p - proc));</span></span><br><span class="line"><span class="addition">+  // uint64 va = KSTACK(0);</span></span><br><span class="line"><span class="addition">+  kvmmap(p-&gt;kpagetable, va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  p-&gt;kstack = va;</span></span><br><span class="line"> </span><br><span class="line">   // An empty user page table.</span><br><span class="line">   p-&gt;pagetable = proc_pagetable(p);</span><br><span class="line"><span class="meta">@@ -139,6 +159,12 @@</span> freeproc(struct proc *p)</span><br><span class="line">   if(p-&gt;trapframe)</span><br><span class="line">     kfree((void*)p-&gt;trapframe);</span><br><span class="line">   p-&gt;trapframe = 0;</span><br><span class="line"><span class="addition">+  if(p-&gt;kstack)</span></span><br><span class="line"><span class="addition">+	uvmunmap(p-&gt;kpagetable, p-&gt;kstack, 1, 1);</span></span><br><span class="line"><span class="addition">+  p-&gt;kstack = 0;</span></span><br><span class="line"><span class="addition">+  if(p-&gt;kpagetable)</span></span><br><span class="line"><span class="addition">+	kvmfree(p-&gt;kpagetable);</span></span><br><span class="line"><span class="addition">+  p-&gt;kpagetable = 0;</span></span><br><span class="line">   if(p-&gt;pagetable)</span><br><span class="line">     proc_freepagetable(p-&gt;pagetable, p-&gt;sz);</span><br><span class="line">   p-&gt;pagetable = 0;</span><br><span class="line"><span class="meta">@@ -195,6 +221,14 @@</span> proc_freepagetable(pagetable_t pagetable, uint64 sz)</span><br><span class="line">   uvmfree(pagetable, sz);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+/*</span></span><br><span class="line"><span class="addition">+void</span></span><br><span class="line"><span class="addition">+proc_freekpagetable(pagetable_t kpgtbl, uint64 kstack, uint64 sz) &#123;</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, kstack, 1, 1);</span></span><br><span class="line"><span class="addition">+	kvmfree(kpgtbl);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+*/</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // a user program that calls exec(&quot;/init&quot;)</span><br><span class="line"> // od -t xC initcode</span><br><span class="line"> uchar initcode[] = &#123;</span><br><span class="line"><span class="meta">@@ -473,11 +507,18 @@</span> scheduler(void)</span><br><span class="line">         // before jumping back to us.</span><br><span class="line">         p-&gt;state = RUNNING;</span><br><span class="line">         c-&gt;proc = p;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+		w_satp(MAKE_SATP(p-&gt;kpagetable));</span></span><br><span class="line"><span class="addition">+		sfence_vma();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">         swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"> </span><br><span class="line">         // Process is done running for now.</span><br><span class="line">         // It should have changed its p-&gt;state before coming back.</span><br><span class="line">         c-&gt;proc = 0;</span><br><span class="line"><span class="addition">+		</span></span><br><span class="line"><span class="addition">+		// use kernel_pagetable when no process is running.</span></span><br><span class="line"><span class="addition">+		kvminithart();</span></span><br><span class="line"> </span><br><span class="line">         found = 1;</span><br><span class="line">       &#125;</span><br><span class="line"><span class="meta">@@ -486,7 +527,11 @@</span> scheduler(void)</span><br><span class="line"> #if !defined (LAB_FS)</span><br><span class="line">     if(found == 0) &#123;</span><br><span class="line">       intr_on();</span><br><span class="line"><span class="deletion">-      asm volatile(&quot;wfi&quot;);</span></span><br><span class="line"><span class="addition">+	  </span></span><br><span class="line"><span class="addition">+	  // use kernel_pagetable when no process is running.</span></span><br><span class="line"><span class="addition">+	  // kvminithart();</span></span><br><span class="line"><span class="addition">+      </span></span><br><span class="line"><span class="addition">+	  asm volatile(&quot;wfi&quot;);</span></span><br><span class="line">     &#125;</span><br><span class="line"> #else</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.h b/kernel/proc.h</span></span><br><span class="line"><span class="comment">index 9c16ea7..7858834 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.h</span></span><br><span class="line"><span class="meta">@@ -98,6 +98,7 @@</span> struct proc &#123;</span><br><span class="line">   uint64 kstack;               // Virtual address of kernel stack</span><br><span class="line">   uint64 sz;                   // Size of process memory (bytes)</span><br><span class="line">   pagetable_t pagetable;       // User page table</span><br><span class="line"><span class="addition">+  pagetable_t kpagetable;      // Kernel page table</span></span><br><span class="line">   struct trapframe *trapframe; // data page for trampoline.S</span><br><span class="line">   struct context context;      // swtch() here to run process</span><br><span class="line">   struct file *ofile[NOFILE];  // Open files</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index 3487f25..8f3f445 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -5,6 +5,8 @@</span></span><br><span class="line"> #include &quot;riscv.h&quot;</span><br><span class="line"> #include &quot;defs.h&quot;</span><br><span class="line"> #include &quot;fs.h&quot;</span><br><span class="line"><span class="addition">+#include &quot;spinlock.h&quot;</span></span><br><span class="line"><span class="addition">+#include &quot;proc.h&quot;</span></span><br><span class="line"> </span><br><span class="line"> /*</span><br><span class="line">  * the kernel&#x27;s page table.</span><br><span class="line"><span class="meta">@@ -16,35 +18,48 @@</span> extern char etext[];  // kernel.ld sets this to end of kernel code.</span><br><span class="line"> extern char trampoline[]; // trampoline.S</span><br><span class="line"> </span><br><span class="line"> /*</span><br><span class="line"><span class="deletion">- * create a direct-map page table for the kernel.</span></span><br><span class="line"><span class="addition">+ * make a direct-map page table for the kernel.</span></span><br><span class="line">  */</span><br><span class="line"><span class="deletion">-void</span></span><br><span class="line"><span class="deletion">-kvminit()</span></span><br><span class="line"><span class="addition">+pagetable_t</span></span><br><span class="line"><span class="addition">+kvmmake()</span></span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  kernel_pagetable = (pagetable_t) kalloc();</span></span><br><span class="line"><span class="deletion">-  memset(kernel_pagetable, 0, PGSIZE);</span></span><br><span class="line"><span class="addition">+  pagetable_t kpagetable = (pagetable_t) kalloc();</span></span><br><span class="line"><span class="addition">+  memset(kpagetable, 0, PGSIZE);</span></span><br><span class="line"> </span><br><span class="line">   // uart registers</span><br><span class="line"><span class="deletion">-  kvmmap(UART0, UART0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, UART0, UART0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"> </span><br><span class="line">   // virtio mmio disk interface</span><br><span class="line"><span class="deletion">-  kvmmap(VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"> </span><br><span class="line">   // CLINT</span><br><span class="line"><span class="deletion">-  kvmmap(CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"> </span><br><span class="line">   // PLIC</span><br><span class="line"><span class="deletion">-  kvmmap(PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span></span><br><span class="line"> </span><br><span class="line">   // map kernel text executable and read-only.</span><br><span class="line"><span class="deletion">-  kvmmap(KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span></span><br><span class="line"> </span><br><span class="line">   // map kernel data and the physical RAM we&#x27;ll make use of.</span><br><span class="line"><span class="deletion">-  kvmmap((uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, (uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span></span><br><span class="line"> </span><br><span class="line">   // map the trampoline for trap entry/exit to</span><br><span class="line">   // the highest virtual address in the kernel.</span><br><span class="line"><span class="deletion">-  kvmmap(TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return kpagetable;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+/*</span></span><br><span class="line"><span class="addition">+ * create a direct-map page table for the kernel.</span></span><br><span class="line"><span class="addition">+ */</span></span><br><span class="line"><span class="addition">+void</span></span><br><span class="line"><span class="addition">+kvminit()</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  kernel_pagetable = kvmmake();</span></span><br><span class="line"><span class="addition">+  // CLINT</span></span><br><span class="line"><span class="addition">+  // kvmmap(kernel_pagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // Switch h/w page table register to the kernel&#x27;s page table,</span><br><span class="line"><span class="meta">@@ -115,9 +130,9 @@</span> walkaddr(pagetable_t pagetable, uint64 va)</span><br><span class="line"> // only used when booting.</span><br><span class="line"> // does not flush TLB or enable paging.</span><br><span class="line"> void</span><br><span class="line"><span class="deletion">-kvmmap(uint64 va, uint64 pa, uint64 sz, int perm)</span></span><br><span class="line"><span class="addition">+kvmmap(pagetable_t kpagetable, uint64 va, uint64 pa, uint64 sz, int perm)</span></span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  if(mappages(kernel_pagetable, va, sz, pa, perm) != 0)</span></span><br><span class="line"><span class="addition">+  if(mappages(kpagetable, va, sz, pa, perm) != 0)</span></span><br><span class="line">     panic(&quot;kvmmap&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -132,7 +147,7 @@</span> kvmpa(uint64 va)</span><br><span class="line">   pte_t *pte;</span><br><span class="line">   uint64 pa;</span><br><span class="line">   </span><br><span class="line"><span class="deletion">-  pte = walk(kernel_pagetable, va, 0);</span></span><br><span class="line"><span class="addition">+  pte = walk(myproc()-&gt;kpagetable, va, 0);</span></span><br><span class="line">   if(pte == 0)</span><br><span class="line">     panic(&quot;kvmpa&quot;);</span><br><span class="line">   if((*pte &amp; PTE_V) == 0)</span><br><span class="line"><span class="meta">@@ -194,6 +209,35 @@</span> uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, int do_free)</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+void</span></span><br><span class="line"><span class="addition">+kvmfree(pagetable_t kpgtbl) &#123;</span></span><br><span class="line"><span class="addition">+	/*</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, UART0, 1, 0);</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, VIRTIO0, 1, 0);</span></span><br><span class="line"><span class="addition">+	// uvmunmap(kpgtbl, CLINT, 0x10000 / PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, PLIC, 0x400000 / PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, KERNBASE, ((uint64)etext-KERNBASE) / PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, (uint64)etext, (PHYSTOP-(uint64)etext) / PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+	uvmunmap(kpgtbl, TRAMPOLINE, 1, 0);</span></span><br><span class="line"><span class="addition">+	// uvmunmap(kpgtbl, 0, PGROUNDUP(sz) / PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+    */</span></span><br><span class="line"><span class="addition">+  // there are 2^9 = 512 PTEs in a page table.</span></span><br><span class="line"><span class="addition">+  for(int i = 0; i &lt; 512; i++)&#123;</span></span><br><span class="line"><span class="addition">+    pte_t pte = kpgtbl[i];</span></span><br><span class="line"><span class="addition">+    if (pte &amp; PTE_V)&#123;</span></span><br><span class="line"><span class="addition">+		kpgtbl[i] = 0;</span></span><br><span class="line"><span class="addition">+		if ((pte &amp; (PTE_R|PTE_W|PTE_X)) == 0) &#123;</span></span><br><span class="line"><span class="addition">+		  // this PTE points to a lower-level page table.</span></span><br><span class="line"><span class="addition">+		  uint64 child = PTE2PA(pte);</span></span><br><span class="line"><span class="addition">+		  kvmfree((pagetable_t)child);</span></span><br><span class="line"><span class="addition">+		&#125;</span></span><br><span class="line"><span class="addition">+    &#125; else if(pte &amp; PTE_V)&#123;</span></span><br><span class="line"><span class="addition">+      panic(&quot;freewalk: leaf&quot;);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+  kfree((void*)kpgtbl);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // create an empty user page table.</span><br><span class="line"> // returns 0 if out of memory.</span><br><span class="line"> pagetable_t</span><br></pre></td></tr></table></figure>

<h2 id="Simplify-copyin-copyinstr"><a href="#Simplify-copyin-copyinstr" class="headerlink" title="Simplify copyin/copyinstr"></a>Simplify <code>copyin/copyinstr</code></h2><p>Replace the body of <code>copyin</code> in <code>kernel/vm.c</code> with a call to <code>copyin_new</code> (defined in <code>kernel/vmcopyin.c</code>); do the same for <code>copyinstr</code> and <code>copyinstr_new</code>. Add mappings for user addresses to each process’s kernel page table so that <code>copyin_new</code> and <code>copyinstr_new</code> work. You pass this assignment if <code>usertests</code> runs correctly and all the <code>make grade</code> tests pass.</p>
<h3 id="主要实现-2"><a href="#主要实现-2" class="headerlink" title="主要实现"></a>主要实现</h3><p>woc，这题我一开始没发现人家已经写好了，还自己手写了一个 <code>copyin_new</code>。。。</p>
<p>这题要做的主要就是把进程的用户页表映射到内核页表。</p>
<ol>
<li>在 defs.h 里添加人家写好的 copyin_new:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// defs.h</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// vmcopyin.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyin_new</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">char</span> *, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyinstr_new</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">char</span> *, uint64, uint64)</span></span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>改掉原来的 copyin：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">copyin(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">char</span> *dst, uint64 srcva, uint64 len)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> copyin_new(pagetable, dst, srcva, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">copyinstr(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">char</span> *dst, uint64 srcva, uint64 max)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> copyinstr_new(pagetable, dst, srcva, max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>写一个函数来把进程的用户页表映射到内核页表：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> </span><br><span class="line">uvm2k(<span class="keyword">pagetable_t</span> pagetable, <span class="keyword">pagetable_t</span> kpgtbl, uint64 oldsz, uint64 newsz) &#123;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte_from, *pte_to;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((newsz &lt; oldsz) || (PGROUNDUP(newsz) &gt;= PLIC))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (uint64 va = PGROUNDUP(oldsz); va &lt; newsz; va += PGSIZE) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((pte_from = walk(pagetable, va, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">			panic(<span class="string">&quot;copyin_new: pte not exist&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> ((pte_to = walk(kpgtbl, va, <span class="number">1</span>)) == <span class="number">0</span>)</span><br><span class="line">			panic(<span class="string">&quot;copyin_new: walk failed&quot;</span>);</span><br><span class="line">		*pte_to = (*pte_from) &amp; (~PTE_U);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在 <code>fork()</code>, <code>exec()</code> 和 <code>sbrk()</code> 里处理 uvm 到 kvm 的映射：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">fork(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// increment reference counts on open file descriptors.</span></span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NOFILE; i++)</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;ofile[i])</span><br><span class="line">      np-&gt;ofile[i] = filedup(p-&gt;ofile[i]);</span><br><span class="line">  np-&gt;cwd = idup(p-&gt;cwd);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// (+)</span></span><br><span class="line">  <span class="keyword">if</span> (uvm2k(np-&gt;pagetable, np-&gt;kpagetable, <span class="number">0</span>, np-&gt;sz) &lt; <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  safestrcpy(np-&gt;name, p-&gt;name, <span class="keyword">sizeof</span>(p-&gt;name));</span><br><span class="line">  pid = np-&gt;pid;</span><br><span class="line">  np-&gt;state = RUNNABLE;</span><br><span class="line">  release(&amp;np-&gt;lock);</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个就是 sbrk 啦</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">growproc(<span class="keyword">int</span> n)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">      </span><br><span class="line">  <span class="keyword">if</span>(n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">if</span> (uvm2k(p-&gt;pagetable, p-&gt;kpagetable, sz-n, sz) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(n &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">if</span> (n &gt;= PGSIZE) &#123;  <span class="comment">// 我不知道为什么这样 if，反正不写会 panic</span></span><br><span class="line">		uvmunmap(p-&gt;kpagetable, PGROUNDUP(sz), n/PGSIZE, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  p-&gt;sz = sz;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exec.c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">exec(<span class="keyword">char</span> *path, <span class="keyword">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate two pages at the next page boundary.</span></span><br><span class="line">  <span class="comment">// Use the second as the user stack.</span></span><br><span class="line">  sz = PGROUNDUP(sz);</span><br><span class="line">  ...</span><br><span class="line">  sp = sz;</span><br><span class="line">  stackbase = sp - PGSIZE;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (uvm2k(pagetable, p-&gt;kpagetable, <span class="number">0</span>, sz) &lt; <span class="number">0</span>)  <span class="comment">// (+)</span></span><br><span class="line">	  <span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Push argument strings, prepare rest of stack in ustack.</span></span><br><span class="line">  <span class="keyword">for</span>(argc = <span class="number">0</span>; argv[argc]; argc++) &#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &gt;= MAXARG)</span><br><span class="line">      <span class="keyword">goto</span> bad;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Diff-1"><a href="#Diff-1" class="headerlink" title="Diff"></a>Diff</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/grade-lab-pgtbl b/grade-lab-pgtbl</span></span><br><span class="line"><span class="comment">index 2b0b49d..bb775b0 100755</span></span><br><span class="line"><span class="comment">--- a/grade-lab-pgtbl</span></span><br><span class="line"><span class="comment">+++ b/grade-lab-pgtbl</span></span><br><span class="line"><span class="meta">@@ -62,7 +62,7 @@</span> def test_count():</span><br><span class="line"> def test_usertests():</span><br><span class="line">     r.run_qemu(shell_script([</span><br><span class="line">         &#x27;usertests&#x27;</span><br><span class="line"><span class="deletion">-    ]), timeout=300)</span></span><br><span class="line"><span class="addition">+    ]), timeout=500)</span></span><br><span class="line"> </span><br><span class="line"> def usertest_check(testcase, nextcase, output):</span><br><span class="line">     if not re.search(r&#x27;\ntest &#123;&#125;: [\s\S]*OK\ntest &#123;&#125;&#x27;.format(testcase, nextcase), output):</span><br><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 6a85a85..2278ec7 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -182,6 +182,7 @@</span> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> void            vmprint(pagetable_t);</span><br><span class="line"> pagetable_t     kvmmake(void);</span><br><span class="line"> void            kvmfree(pagetable_t);</span><br><span class="line"><span class="addition">+int             uvm2k(pagetable_t, pagetable_t, uint64, uint64);</span></span><br><span class="line"> </span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="meta">@@ -194,6 +195,10 @@</span> void            virtio_disk_init(void);</span><br><span class="line"> void            virtio_disk_rw(struct buf *, int);</span><br><span class="line"> void            virtio_disk_intr(void);</span><br><span class="line"> </span><br><span class="line"><span class="addition">+// vmcopyin.c</span></span><br><span class="line"><span class="addition">+int             copyin_new(pagetable_t, char *, uint64, uint64);</span></span><br><span class="line"><span class="addition">+int             copyinstr_new(pagetable_t, char *, uint64, uint64);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // number of elements in fixed-size array</span><br><span class="line"> #define NELEM(x) (sizeof(x)/sizeof((x)[0]))</span><br><span class="line"> </span><br><span class="line"><span class="comment">diff --git a/kernel/exec.c b/kernel/exec.c</span></span><br><span class="line"><span class="comment">index 4c41c7d..daeda2b 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/exec.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/exec.c</span></span><br><span class="line"><span class="meta">@@ -75,6 +75,9 @@</span> exec(char *path, char **argv)</span><br><span class="line">   sp = sz;</span><br><span class="line">   stackbase = sp - PGSIZE;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+  if (uvm2k(pagetable, p-&gt;kpagetable, 0, sz) &lt; 0)</span></span><br><span class="line"><span class="addition">+	  goto bad;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   // Push argument strings, prepare rest of stack in ustack.</span><br><span class="line">   for(argc = 0; argv[argc]; argc++) &#123;</span><br><span class="line">     if(argc &gt;= MAXARG)</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index d731950..6cff554 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -255,6 +255,8 @@</span> userinit(void)</span><br><span class="line">   uvminit(p-&gt;pagetable, initcode, sizeof(initcode));</span><br><span class="line">   p-&gt;sz = PGSIZE;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+  uvm2k(p-&gt;pagetable, p-&gt;kpagetable, 0, p-&gt;sz);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   // prepare for the very first &quot;return&quot; from kernel to user.</span><br><span class="line">   p-&gt;trapframe-&gt;epc = 0;      // user program counter</span><br><span class="line">   p-&gt;trapframe-&gt;sp = PGSIZE;  // user stack pointer</span><br><span class="line"><span class="meta">@@ -280,9 +282,16 @@</span> growproc(int n)</span><br><span class="line">     if((sz = uvmalloc(p-&gt;pagetable, sz, sz + n)) == 0) &#123;</span><br><span class="line">       return -1;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="addition">+	if (uvm2k(p-&gt;pagetable, p-&gt;kpagetable, sz-n, sz) &lt; 0) &#123;</span></span><br><span class="line"><span class="addition">+		return -1;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line">   &#125; else if(n &lt; 0)&#123;</span><br><span class="line">     sz = uvmdealloc(p-&gt;pagetable, sz, sz + n);</span><br><span class="line"><span class="addition">+	if (n &gt;= PGSIZE) &#123;</span></span><br><span class="line"><span class="addition">+		uvmunmap(p-&gt;kpagetable, PGROUNDUP(sz), n/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   p-&gt;sz = sz;</span><br><span class="line">   return 0;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">@@ -323,6 +332,9 @@</span> fork(void)</span><br><span class="line">       np-&gt;ofile[i] = filedup(p-&gt;ofile[i]);</span><br><span class="line">   np-&gt;cwd = idup(p-&gt;cwd);</span><br><span class="line"> </span><br><span class="line"><span class="addition">+  if (uvm2k(np-&gt;pagetable, np-&gt;kpagetable, 0, np-&gt;sz) &lt; 0)</span></span><br><span class="line"><span class="addition">+	return -1;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   safestrcpy(np-&gt;name, p-&gt;name, sizeof(p-&gt;name));</span><br><span class="line"> </span><br><span class="line">   pid = np-&gt;pid;</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index 8f3f445..361aa5d 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -417,29 +417,32 @@</span> copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span><br><span class="line">   return 0;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+// maps users pagetble to a kpgtbl</span></span><br><span class="line"><span class="addition">+int </span></span><br><span class="line"><span class="addition">+uvm2k(pagetable_t pagetable, pagetable_t kpgtbl, uint64 oldsz, uint64 newsz) &#123;</span></span><br><span class="line"><span class="addition">+	pte_t *pte_from, *pte_to;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	if ((newsz &lt; oldsz) || (PGROUNDUP(newsz) &gt;= PLIC))</span></span><br><span class="line"><span class="addition">+		return -1;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	for (uint64 va = PGROUNDUP(oldsz); va &lt; newsz; va += PGSIZE) &#123;</span></span><br><span class="line"><span class="addition">+		if ((pte_from = walk(pagetable, va, 0)) == 0)</span></span><br><span class="line"><span class="addition">+			panic(&quot;copyin_new: pte not exist&quot;);</span></span><br><span class="line"><span class="addition">+		if ((pte_to = walk(kpgtbl, va, 1)) == 0)</span></span><br><span class="line"><span class="addition">+			panic(&quot;copyin_new: walk failed&quot;);</span></span><br><span class="line"><span class="addition">+		*pte_to = (*pte_from) &amp; (~PTE_U);</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	return 0;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // Copy from user to kernel.</span><br><span class="line"> // Copy len bytes to dst from virtual address srcva in a given page table.</span><br><span class="line"> // Return 0 on success, -1 on error.</span><br><span class="line"> int</span><br><span class="line"> copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  uint64 n, va0, pa0;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-  while(len &gt; 0)&#123;</span></span><br><span class="line"><span class="deletion">-    va0 = PGROUNDDOWN(srcva);</span></span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="deletion">-    if(pa0 == 0)</span></span><br><span class="line"><span class="deletion">-      return -1;</span></span><br><span class="line"><span class="deletion">-    n = PGSIZE - (srcva - va0);</span></span><br><span class="line"><span class="deletion">-    if(n &gt; len)</span></span><br><span class="line"><span class="deletion">-      n = len;</span></span><br><span class="line"><span class="deletion">-    memmove(dst, (void *)(pa0 + (srcva - va0)), n);</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    len -= n;</span></span><br><span class="line"><span class="deletion">-    dst += n;</span></span><br><span class="line"><span class="deletion">-    srcva = va0 + PGSIZE;</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="deletion">-  return 0;</span></span><br><span class="line"><span class="addition">+  return copyin_new(pagetable, dst, srcva, len);</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> // Copy a null-terminated string from user to kernel.</span><br><span class="line"><span class="meta">@@ -449,40 +452,7 @@</span> copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len)</span><br><span class="line"> int</span><br><span class="line"> copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  uint64 n, va0, pa0;</span></span><br><span class="line"><span class="deletion">-  int got_null = 0;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-  while(got_null == 0 &amp;&amp; max &gt; 0)&#123;</span></span><br><span class="line"><span class="deletion">-    va0 = PGROUNDDOWN(srcva);</span></span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="deletion">-    if(pa0 == 0)</span></span><br><span class="line"><span class="deletion">-      return -1;</span></span><br><span class="line"><span class="deletion">-    n = PGSIZE - (srcva - va0);</span></span><br><span class="line"><span class="deletion">-    if(n &gt; max)</span></span><br><span class="line"><span class="deletion">-      n = max;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    char *p = (char *) (pa0 + (srcva - va0));</span></span><br><span class="line"><span class="deletion">-    while(n &gt; 0)&#123;</span></span><br><span class="line"><span class="deletion">-      if(*p == &#x27;\0&#x27;)&#123;</span></span><br><span class="line"><span class="deletion">-        *dst = &#x27;\0&#x27;;</span></span><br><span class="line"><span class="deletion">-        got_null = 1;</span></span><br><span class="line"><span class="deletion">-        break;</span></span><br><span class="line"><span class="deletion">-      &#125; else &#123;</span></span><br><span class="line"><span class="deletion">-        *dst = *p;</span></span><br><span class="line"><span class="deletion">-      &#125;</span></span><br><span class="line"><span class="deletion">-      --n;</span></span><br><span class="line"><span class="deletion">-      --max;</span></span><br><span class="line"><span class="deletion">-      p++;</span></span><br><span class="line"><span class="deletion">-      dst++;</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    srcva = va0 + PGSIZE;</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="deletion">-  if(got_null)&#123;</span></span><br><span class="line"><span class="deletion">-    return 0;</span></span><br><span class="line"><span class="deletion">-  &#125; else &#123;</span></span><br><span class="line"><span class="deletion">-    return -1;</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="addition">+	return copyinstr_new(pagetable, dst, srcva, max);</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> void</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>emmm，好像我在第二题做的有问题，usertests 会：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usertrap(): unexpected scause <span class="number">0x000000000000000d</span> pid=<span class="number">6227</span></span><br><span class="line">            sepc=<span class="number">0x000000000000201a</span> stval=<span class="number">0x00000000800493e0</span></span><br></pre></td></tr></table></figure>

<p>不知道哪里错了。。</p>
<p>然后其实我跑 make grade 有时候 usertests 会超时（它超时是300秒，我要 300 秒多一点点，改改测试脚本就能过了[狗头]）。不知道为什么，qemu 跑着跑着在宿主机上的 CPU 占用就从 100% 降到 20% 左右了。。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">== Test pte printout == </span><br><span class="line">$ make qemu-gdb</span><br><span class="line">pte printout: OK (<span class="number">3.8</span>s) </span><br><span class="line">== Test answers-pgtbl.txt == answers-pgtbl.txt: OK </span><br><span class="line">== Test count copyin == </span><br><span class="line">$ make qemu-gdb</span><br><span class="line">count copyin: OK (<span class="number">1.4</span>s) </span><br><span class="line">== Test usertests == </span><br><span class="line">$ make qemu-gdb</span><br><span class="line">(<span class="number">312.6</span>s) </span><br><span class="line">== Test   usertests: copyin == </span><br><span class="line">  usertests: copyin: OK </span><br><span class="line">== Test   usertests: copyinstr1 == </span><br><span class="line">  usertests: copyinstr1: OK </span><br><span class="line">== Test   usertests: copyinstr2 == </span><br><span class="line">  usertests: copyinstr2: OK </span><br><span class="line">== Test   usertests: copyinstr3 == </span><br><span class="line">  usertests: copyinstr3: OK </span><br><span class="line">== Test   usertests: sbrkmuch == </span><br><span class="line">  usertests: sbrkmuch: OK </span><br><span class="line">== Test   usertests: all tests == </span><br><span class="line">  usertests: all tests: OK </span><br><span class="line">== Test time == </span><br><span class="line">time: OK </span><br><span class="line">Score: <span class="number">66</span>/<span class="number">66</span></span><br></pre></td></tr></table></figure>

<p>反正勉强能过那就先就这样吧，有时间再研究一下。</p>
<hr>
<p>2021.03.13  CDFMLR</p>
<p>顶部图片来自于<a target="_blank" rel="noopener" href="https://api.ixiaowai.cn/">小歪API</a>，系随机选取的图片，仅用于检测屏幕显示的机械、光电性能，与文章的任何内容及观点无关，也并不代表本人局部或全部同意、支持或者反对其中的任何内容及观点。如有侵权，联系删除。</p>

  </div>
</article>
<!--Disqus-->


<!--Livere-->

    <div class="blog-post-comments">
        <div id="lv-container" data-id="city" data-uid="MTAyMC80NjEzMi8yMjY0Mw==">
            <noscript>不启用 JavaScript 支持的人是看不到可爱的评论区的。😥</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Lab-page-tables"><span class="toc-number">1.</span> <span class="toc-text">Lab: page tables</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Print-a-page-table"><span class="toc-number">1.1.</span> <span class="toc-text">Print a page table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">主要实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E7%9A%84diff"><span class="toc-number">1.1.2.</span> <span class="toc-text">详细的diff</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-kernel-page-table-per-process"><span class="toc-number">1.2.</span> <span class="toc-text">A kernel page table per process</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">主要实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diff"><span class="toc-number">1.2.2.</span> <span class="toc-text">Diff</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Simplify-copyin-copyinstr"><span class="toc-number">1.3.</span> <span class="toc-text">Simplify copyin&#x2F;copyinstr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">主要实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diff-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">Diff</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">1.4.</span> <span class="toc-text">最后</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&text=Xv6 Lab page tables"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&is_video=false&description=Xv6 Lab page tables"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Xv6 Lab page tables&body=Check out this article: https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&title=Xv6 Lab page tables"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://clownote.github.io/2021/03/11/xv6/Xv6-Lab-page-tables/&name=Xv6 Lab page tables&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2022 CDFMLR
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cdfmlr">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-146911386-1', 'auto');
        ga('send', 'pageview');
    </script>
    
    <!-- New: global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146911386-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-146911386-1');
    </script>
    

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?9a0d2e6fde93dad496ac79f04f3aba97";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


<!--Livere Comments-->

    <script type="text/javascript">
      (function (d, s) {
        var j, e = d.getElementsByTagName(s)[0];

        if (typeof LivereTower === 'function') { return; }

        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;

        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>


</body>
</html>
